<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlinkRandom | Professional Messaging Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add WebSocket libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --border-radius: 10px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            box-shadow: var(--shadow);
            background-color: white;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.3rem;
        }

        .logo i {
            font-size: 1.5rem;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 50px;
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }

        #dashboardBtn {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        #dashboardBtn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        #logoutBtn {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        #logoutBtn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Main Content */
        .chat-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background: var(--light);
            border-right: 1px solid var(--light-gray);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            background: white;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 600;
            font-size: 0.85rem;
            position: relative;
        }

        .sidebar-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: var(--light);
        }

        .sidebar-tab:hover {
            background: var(--light-gray);
        }

        .tab-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            display: none;
        }

        .tab-indicator.active {
            display: block;
            animation: pulse 2s infinite;
        }

        .search-container {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
            background: white;
        }

        .search-box {
            position: relative;
            margin-bottom: 8px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 0.8rem;
        }

        .filter-options {
            display: flex;
            gap: 8px;
        }

        .filter-select {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.75rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.75rem;
            background: white;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-list {
            list-style: none;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 6px;
            position: relative;
        }

        .user-item:hover {
            background: white;
            box-shadow: var(--shadow);
        }

        .user-item.active {
            background: white;
            box-shadow: var(--shadow);
            border-left: 3px solid var(--primary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            position: relative;
        }

        .user-details {
            flex: 1;
            position: relative;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.85rem;
        }

        .user-info-small {
            font-size: 0.7rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-status {
            font-size: 0.7rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.away {
            background: var(--warning);
        }

        .status-indicator.offline {
            background: var(--gray);
        }

        .gender-icon {
            font-size: 0.6rem;
            margin-right: 2px;
        }

        .country-flag {
            font-size: 0.7rem;
            margin-right: 2px;
        }

        /* Message Indicator Styles */
        .message-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            border-radius: 50%;
            border: 3px solid white;
            animation: pulse 2s infinite;
            display: none;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(247, 37, 133, 0.4);
        }

        .message-indicator.with-count {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, var(--danger) 0%, #d4145a 100%);
        }

        .message-indicator.with-count[data-count="1"],
        .message-indicator.with-count[data-count="2"],
        .message-indicator.with-count[data-count="3"] {
            width: 26px;
            height: 26px;
            font-size: 0.95rem;
            font-weight: 900;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.7);
            }
            50% {
                transform: scale(1.15);
                opacity: 0.9;
                box-shadow: 0 0 0 8px rgba(247, 37, 133, 0);
            }
            100% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0);
            }
        }

        .new-message-label {
            position: absolute;
            top: -8px;
            right: 8px;
            background: linear-gradient(135deg, var(--danger) 0%, #d4145a 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 800;
            animation: bounce 0.5s ease;
            z-index: 5;
            box-shadow: 0 2px 6px rgba(247, 37, 133, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        /* Chat Area Styles */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .chat-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
        }

        .current-chat-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-chat-user .user-avatar {
            width: 34px;
            height: 34px;
            font-size: 0.8rem;
        }

        .chat-info h3 {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        .chat-info p {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .user-details-extended {
            display: flex;
            gap: 10px;
            margin-top: 2px;
        }

        .user-detail {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            color: var(--gray);
        }

        .messages {
            flex: 1;
            padding: 15px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .message {
            max-width: 75%;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-bubble {
            padding: 8px 14px;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            color: var(--dark);
            border: 1px solid var(--light-gray);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 0.65rem;
            color: var(--gray);
            margin-top: 4px;
        }

        .message.sent .message-time {
            text-align: right;
        }

        .input-area {
            padding: 15px;
            border-top: 1px solid var(--light-gray);
            background: white;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-actions button {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .input-actions button:hover {
            color: var(--primary);
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 0.85rem;
            transition: var(--transition);
            max-height: 100px;
            min-height: 40px;
            line-height: 1.4;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .send-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            font-size: 0.8rem;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        /* Emoji Picker Styles - UPDATED WITH SCROLLING */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 10px;
            z-index: 100;
            display: none;
            max-width: 300px;
            max-height: 200px;
            flex-wrap: wrap;
            gap: 5px;
            overflow-y: auto;
            border: 1px solid var(--light-gray);
        }

        .emoji-picker.active {
            display: flex;
        }

        /* Emoji picker scrollbar styling */
        .emoji-picker::-webkit-scrollbar {
            width: 6px;
        }

        .emoji-picker::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }

        .emoji-picker::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 3px;
        }

        .emoji-picker::-webkit-scrollbar-thumb:hover {
            background: var(--dark);
        }

        .emoji {
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .emoji:hover {
            background: var(--light-gray);
            transform: scale(1.2);
        }

        /* Make emoji picker responsive */
        @media (max-width: 768px) {
            .emoji-picker {
                max-width: 250px;
                max-height: 150px;
                left: 10px;
                bottom: 60px;
            }

            .emoji {
                font-size: 1.1rem;
                padding: 4px;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar .user-details,
            .sidebar-section h3,
            .search-container,
            .sidebar-tabs span {
                display: none;
            }

            .user-item {
                justify-content: center;
            }

            .message {
                max-width: 85%;
            }

            .user-details-extended {
                flex-direction: column;
                gap: 2px;
            }

            .message-indicator {
                top: -2px;
                right: -2px;
                width: 16px;
                height: 16px;
            }

            .message-indicator.with-count {
                width: 20px;
                height: 20px;
                font-size: 0.75rem;
            }

            .message-indicator.with-count[data-count="1"],
            .message-indicator.with-count[data-count="2"],
            .message-indicator.with-count[data-count="3"] {
                width: 22px;
                height: 22px;
                font-size: 0.85rem;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark);
        }

        .status-indicator.offline {
            background: #ccc !important;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
<div class="app-container">
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <span>BlinkRandom</span>
        </div>
        <div class="profile">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <span id="username">User</span>
            </div>
            <button id="dashboardBtn">
                <i class="fas fa-arrow-left"></i>
                Dashboard
            </button>
            <button id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </header>

    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Connect with People</h3>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="active">
                    <span>Active Users</span>
                    <div class="tab-indicator" id="activeTabIndicator"></div>
                </div>
                <div class="sidebar-tab" data-tab="inbox">
                    <span>Inbox</span>
                    <div class="tab-indicator" id="inboxTabIndicator"></div>
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="userSearch" class="search-input" placeholder="Search users...">
                </div>
                <div class="filter-options">
                    <select id="genderFilter" class="filter-select">
                        <option value="">All Genders</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                    <input type="text" id="countryFilter" class="filter-input" placeholder="Country...">
                </div>
            </div>

            <div class="sidebar-content">
                <!-- Active Users Tab -->
                <div class="tab-content active" id="activeTab">
                    <div class="sidebar-section">
                        <ul class="user-list" id="userList">
                            <!-- Active users will be populated here -->
                        </ul>
                    </div>
                </div>

                <!-- Inbox Tab -->
                <div class="tab-content" id="inboxTab">
                    <div class="sidebar-section">
                        <ul class="user-list" id="inboxList">
                            <!-- Inbox users will be populated here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="current-chat-user">
                    <div class="user-avatar" id="currentChatAvatar">JD</div>
                    <div class="chat-info">
                        <h3 id="currentChatName">John Doe</h3>
                        <p id="currentChatStatus">Online - Last seen just now</p>
                        <div class="user-details-extended">
                            <div class="user-detail">
                                <i class="fas fa-venus-mars gender-icon"></i>
                                <span id="currentChatGender">Male</span>
                            </div>
                            <div class="user-detail">
                                <i class="fas fa-globe country-flag"></i>
                                <span id="currentChatCountry">USA</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages" id="messages">
                <div class="no-chat">Select a user to start chatting</div>
            </div>

            <div class="input-area">
                <div class="input-actions">
                    <button id="emojiButton"><i class="fas fa-smile"></i></button>
                    <button><i class="fas fa-image"></i></button>
                </div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <!-- Emoji Picker -->
                <div class="emoji-picker" id="emojiPicker">
                    <!-- Emojis will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Separate URLs for different microservices
    const userApiUrl = "http://localhost:8080/api/user";
    const chatApiUrl = "http://localhost:8081"; // Chat Service base URL

    // Global variables
    let stompClient = null;
    let isWebSocketConnected = false;
    let userName = null;
    let userId = null;
    let unreadMessages = {}; // Track unread messages per user
    let currentChatUser = null; // Track currently open chat
    let gender = null;
    let country = null;
    let connectionRetryCount = 0;
    const MAX_RETRIES = 3;
    let activeTab = 'active'; // 'active' or 'inbox'
    let inboxUsers = new Map(); // Track users in inbox: {userId: {userData, unread}}
    let inboxUnreadCount = 0; // Total unread messages in inbox
    let currentlySelectedUserId = null; // Track currently selected user ID

    // Emoji data
   const emojis = [
  'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
  'üôÇ', 'üôÉ', 'üòâ', 'üòå',

  // Expanded love/heart emojis
  'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üíñ', 'üíó', 'üíì', 'üíû',
  'üíï', 'üíò', 'üíù', 'üíü', 'ü•≤', 'ü§é', 'üß°', '‚ù§Ô∏è‚Äçüî•', '‚ù§Ô∏è‚Äçü©π', 'üíå',
  '‚ù§Ô∏è', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'üíã', 'üë©‚Äç‚ù§Ô∏è‚Äçüë®', 'üë®‚Äç‚ù§Ô∏è‚Äçüë®',

  // Additional facial expressions & people
  'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
  'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
  'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
  'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
  'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ',
  'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
  'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà',

  // Fantasy & characters
  'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ',
  'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø',
  'üòæ',

  // Hand gestures & body parts
  'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û',
  'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç',
  'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù',
  'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶µ', 'ü¶ø', 'ü¶∂', 'üëÇ',
  'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ',

  // Animals & nature
  'üêµ', 'üêí', 'ü¶ç', 'ü¶ß', 'üê∂', 'üêï', 'ü¶Æ', 'üê©', 'üê∫', 'ü¶ä',
  'ü¶ù', 'üê±', 'üêà', 'ü¶Å', 'üêØ', 'üêÖ', 'üêÜ', 'üê¥', 'üêé', 'ü¶Ñ',
  'ü¶ì', 'ü¶å', 'üêÆ', 'üêÇ', 'üêÉ', 'üêÑ', 'üê∑', 'üêñ', 'üêó', 'üêΩ',
  'üêè', 'üêë', 'üêê', 'üê™', 'üê´', 'ü¶ô', 'ü¶í', 'üêò', 'ü¶è', 'ü¶õ',
  'üê≠', 'üêÅ', 'üêÄ', 'üêπ', 'üê∞', 'üêá', 'üêøÔ∏è', 'ü¶´', 'ü¶î', 'ü¶á',
  'üêª', 'üê®', 'üêº', 'ü¶•', 'ü¶¶', 'ü¶®', 'ü¶ò', 'ü¶°', 'üêæ', 'ü¶É',
  'üêî', 'üêì', 'üê£', 'üê§', 'üê•', 'üê¶', 'üêß', 'üïäÔ∏è', 'ü¶Ö', 'ü¶Ü',
  'ü¶¢', 'ü¶â', 'ü¶§', 'ü¶©', 'ü¶ö', 'ü¶ú', 'üê∏', 'üêä', 'üê¢', 'ü¶é',
  'üêç', 'üê≤', 'üêâ', 'ü¶ï', 'ü¶ñ', 'üê≥', 'üêã', 'üê¨', 'ü¶≠', 'üêü',
  'üê†', 'üê°', 'ü¶à', 'üêô', 'üêö', 'üêå', 'ü¶ã', 'üêõ', 'üêú', 'üêù',
  'ü™≤', 'üêû', 'ü¶ó', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'ü¶ü', 'ü¶†', 'üíê', 'üå∏',
  'üíÆ', 'üèµÔ∏è', 'üåπ', 'ü•Ä', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üå±', 'ü™¥',
  'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üåæ', 'üåø', '‚òòÔ∏è', 'üçÄ', 'üçÅ', 'üçÇ',
  'üçÉ', 'üçÑ', 'üå∞', 'ü¶Ä', 'ü¶û', 'ü¶ê', 'ü¶ë', 'üåç', 'üåé', 'üåè',
  'üåê', 'ü™ê', 'üí´', '‚≠ê', 'üåü', '‚ú®', '‚ö°', '‚òÑÔ∏è', 'üí•', 'üî•',
  'üå™Ô∏è', 'üåà', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå•Ô∏è', '‚òÅÔ∏è', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è',
  'üå©Ô∏è', 'üå®Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå¨Ô∏è', 'üí®', 'üíß', 'üí¶', '‚òî',
  '‚òÇÔ∏è', 'üåä', 'üå´Ô∏è',

  // Food & drinks
  'üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê',
  'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë',
  'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ',
  'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥',
  'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî',
  'üçü', 'üçï', 'ü´ì', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó',
  'ü•ò', 'ü´ï', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü',
  'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°',
  'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨',
  'üç´', 'üçø', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'ü´ò', 'üçØ', 'ü•õ', 'üçº',
  'ü´ñ', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üç∫', 'üçª', 'ü•Ç',
  'üç∑', 'ü•É', 'üç∏', 'üçπ', 'üßâ', 'üçæ', 'üßä', 'ü•Ñ', 'üç¥', 'üçΩÔ∏è',
  'ü•£', 'ü•°', 'ü•¢', 'üßÇ',

  // Activities & sports
  '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±',
  'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'üéø', '‚õ∑Ô∏è', 'üèÇ',
  'ü™Ç', 'üèãÔ∏è', 'ü§º', 'ü§∏', '‚õπÔ∏è', 'ü§æ', 'üèåÔ∏è', 'üèá', 'üßò', 'üèÑ',
  'üèä', 'ü§Ω', 'üö£', 'üßó', 'üö¥', 'üöµ', 'ü§π', 'ü§∫', 'ü•ä', 'ü•ã',
  'üéØ', 'ü™É', 'ü•Ö', 'üõπ', 'üõº', 'üé≤', '‚ôüÔ∏è', 'üéÆ', 'üé≥', 'üé≠',
  'ü©∞', 'üé®', 'üé™', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'ü™ò', 'üé∑',
  'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üé¨', 'üèÜ', 'üé´', 'üéóÔ∏è', 'üéüÔ∏è', 'üé≠',

  // Travel & places
  'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê',
  'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', 'üõπ', 'üõº',
  'üöÅ', '‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÄ', 'üõ∏', 'üöâ',
  'üöä', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 'üöã', 'üöå',
  'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò',
  'üöô', 'üöö', 'üöõ', 'üöú', 'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•',
  'üè¶', 'üè®', 'üè©', 'üè™', 'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', 'üíí',
  'üóº', 'üóΩ', '‚õ™', 'üïå', 'üõï', 'üïç', '‚õ©Ô∏è', 'üïã', 'üåÑ', 'üåÖ',
  'üåÜ', 'üåá', 'üåÉ', 'üé†', 'üé°', 'üé¢', 'üíà', 'üåå', 'üéá', 'üéÜ',
  'üå†', 'üéë', 'üíé', '‚ö±Ô∏è', 'üöÇ', 'üåâ', 'üé†', '‚öì', 'üö¢', '‚õµ',
  'üõ∂', 'üö§', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üõ•Ô∏è', 'üöü', 'üö†', 'üö°', 'üõ∞Ô∏è', 'üöÅ',

  // Objects & symbols
  '‚ù§Ô∏è', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è',
  'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è',
  '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé',
  '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë',
  '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂',
  'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è',
  'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò',
  '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑',
  'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî',
  '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞',
  '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è',
  'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ',
  'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ',
  'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï',
  'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£',
  '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è',
  '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ',
  '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è',
  '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ',
  'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', '‚ôæÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è',
  '¬ÆÔ∏è', '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú', '‚úîÔ∏è',
  '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™',
  'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'üî≤', '‚ñ™Ô∏è',
  '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶',
  'üü™', '‚¨õ', '‚¨ú', 'üü´', 'üîà', 'üîá', 'üîâ', 'üîä', 'üîî', 'üîï',
  'üì£', 'üì¢', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üí¨', 'üí≠', 'üóØÔ∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è',
  'üÉè', 'üé¥', 'üÄÑ', 'üì©', 'üì®', 'üìß', 'üíå', 'üì•', 'üì§', 'üì¶',
  'üè∑Ô∏è', 'üì™', 'üì´', 'üì¨', 'üì≠', 'üìÆ', 'üìØ', 'üìú', 'üìÉ', 'üìÑ',
  'üìë', 'üßæ', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÜ', 'üìÖ', 'üóëÔ∏è',
  'üìá', 'üóÉÔ∏è', 'üó≥Ô∏è', 'üóÑÔ∏è', 'üìã', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üóûÔ∏è', 'üì∞',
  'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ',
  'üß∑', 'üîó', 'üìé', 'üñáÔ∏è', 'üìê', 'üìè', 'üßÆ', 'üìå', 'üìç', '‚úÇÔ∏è',
  'üñäÔ∏è', 'üñãÔ∏è', '‚úíÔ∏è', 'üñåÔ∏è', 'üñçÔ∏è', 'üìù', '‚úèÔ∏è', 'üîç', 'üîé', 'üîè',
  'üîê', 'üîí', 'üîì', '‚ù§Ô∏è‚Äçüî•', '‚ù§Ô∏è‚Äçü©π', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú'
];


    // Initialize emoji picker with scrolling
    function initializeEmojiPicker() {
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiButton = document.getElementById('emojiButton');

        // Clear any existing emojis
        emojiPicker.innerHTML = '';

        // Populate emoji picker with all emojis
        emojis.forEach(emoji => {
            const emojiElement = document.createElement('span');
            emojiElement.className = 'emoji';
            emojiElement.textContent = emoji;
            emojiElement.title = emoji; // Show emoji on hover
            emojiElement.addEventListener('click', () => {
                insertEmoji(emoji);
            });
            emojiPicker.appendChild(emojiElement);
        });

        // Toggle emoji picker visibility
        emojiButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            emojiPicker.classList.toggle('active');

            // Scroll to top when opening
            if (emojiPicker.classList.contains('active')) {
                emojiPicker.scrollTop = 0;
            }
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
                emojiPicker.classList.remove('active');
            }
        });

        // Prevent emoji picker from closing when scrolling inside it
        emojiPicker.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        console.log('‚úÖ Emoji picker initialized with', emojis.length, 'emojis');
    }

    // Insert emoji into message input
    function insertEmoji(emoji) {
        const messageInput = document.getElementById('messageInput');
        const startPos = messageInput.selectionStart;
        const endPos = messageInput.selectionEnd;

        messageInput.value = messageInput.value.substring(0, startPos) +
                            emoji +
                            messageInput.value.substring(endPos);

        // Set cursor position after the inserted emoji
        messageInput.selectionStart = messageInput.selectionEnd = startPos + emoji.length;
        messageInput.focus();

        // Close emoji picker
        document.getElementById('emojiPicker').classList.remove('active');
    }

    // Check session and get user data
    function checkUserSession() {
        return fetch(`${userApiUrl}/session-check`, {
            method: "GET",
            credentials: "include"
        })
        .then(response => {
            if (!response.ok) throw new Error('Session invalid');
            return response.json();
        })
        .then(userData => {
            console.log('‚úÖ Session valid, user data:', userData);

            userName = userData.userName;
            userId = userData.userId;
            gender = userData.gender;
            country = userData.country;

            document.getElementById("username").textContent = userName;
            document.getElementById("userAvatar").textContent = userName.charAt(0).toUpperCase();

            return userData;
        })
        .catch(error => {
            console.error('‚ùå Session check failed:', error);
            // REDIRECT TO DASHBOARD INSTEAD OF SIGNIN
            window.location.href = "dashboard.html";
        });
    }

    // WebSocket connection with Promise
    function connectWebSocket() {
        return new Promise((resolve, reject) => {
            if (!userId) {
                console.error('‚ùå Cannot connect WebSocket: userId is null');
                reject(new Error('userId is null'));
                return;
            }

            // Clear any existing connection
            if (stompClient && isWebSocketConnected) {
                console.log('üîÑ Disconnecting existing WebSocket...');
                stompClient.disconnect();
            }

            try {
                console.log('üîå Connecting WebSocket for userId:', userId);

                const socket = new SockJS('http://localhost:8081/ws-chat');
                stompClient = Stomp.over(socket);

                // Set a connection timeout
                const connectionTimeout = setTimeout(() => {
                    console.error('‚ùå WebSocket connection timeout');
                    reject(new Error('Connection timeout'));
                }, 10000); // 10 seconds timeout

                stompClient.connect(
                    {
                        'userId': userId.toString(),
                        'userName': userName,
                        'gender': gender,
                        'country': country
                    },
                    function(frame) {
                        clearTimeout(connectionTimeout);
                        console.log('‚úÖ WebSocket Connected');
                        isWebSocketConnected = true;
                        connectionRetryCount = 0; // Reset retry count on successful connection

                        // Subscribe to receive private messages
                        const privateTopic = "/topic/user/" + userId;
                        console.log('üì° Subscribing to private messages:', privateTopic);

                        stompClient.subscribe(privateTopic, function(message) {
                            console.log("üì® Message received:", message.body);
                            try {
                                const messageData = JSON.parse(message.body);
                                handleIncomingMessage(messageData);
                            } catch (e) {
                                console.error("‚ùå Error parsing message:", e);
                            }
                        });

                        // Subscribe to user status changes
                        const statusTopic = "/topic/status-change";
                        console.log('üì° Subscribing to status updates:', statusTopic);

                        const statusSubscription = stompClient.subscribe(statusTopic, function(message) {
                            console.log("üîÑ Status update received:", message.body);
                            try {
                                const statusUpdate = JSON.parse(message.body);
                                handleStatusUpdate(statusUpdate);
                            } catch (e) {
                                console.error("‚ùå Error parsing status update:", e);
                            }
                        });

                        // Verify subscription is active
                        if (statusSubscription) {
                            console.log('‚úÖ Status subscription active');
                        } else {
                            console.error('‚ùå Status subscription failed');
                        }

                        resolve(frame);
                    },
                    function(error) {
                        clearTimeout(connectionTimeout);
                        console.error('‚ùå WebSocket connection error:', error);
                        isWebSocketConnected = false;

                        // Retry logic
                        if (connectionRetryCount < MAX_RETRIES) {
                            connectionRetryCount++;
                            console.log(`üîÑ Retrying connection (${connectionRetryCount}/${MAX_RETRIES})...`);
                            setTimeout(() => {
                                connectWebSocket().then(resolve).catch(reject);
                            }, 2000 * connectionRetryCount); // Exponential backoff
                        } else {
                            reject(error);
                        }
                    }
                );

            } catch (error) {
                console.error('‚ùå Error in WebSocket setup:', error);
                reject(error);
            }
        });
    }

    // Connection monitoring
    function monitorConnection() {
        setInterval(() => {
            if (!isWebSocketConnected) {
                console.log('üîÑ WebSocket disconnected, attempting reconnect...');
                connectWebSocket()
                    .then(() => console.log('‚úÖ WebSocket reconnected'))
                    .catch(error => console.error('‚ùå WebSocket reconnect failed:', error));
            }
        }, 30000); // Check every 30 seconds
    }

    // Handle incoming messages
    function handleIncomingMessage(messageData) {
        const senderId = parseInt(messageData.senderId);

        console.log('üì® Processing incoming message from:', senderId, 'currently selected user:', currentlySelectedUserId);

        // Add to inbox users (only for received messages)
        if (senderId !== userId) {
            addToInbox(senderId, messageData, true);
        }

        // Check if message is from currently active chat
        const isFromActiveChat = senderId === currentlySelectedUserId;

        if (isFromActiveChat) {
            // Display message immediately if it's from active chat
            displayMessage(messageData);
        } else if (senderId !== userId) {
            // Show message indicator only for received messages (not sent)
            showMessageIndicator(senderId);

            // Move user to top of the list
            moveUserToTop(senderId);
        }

        // Also display if it's your own message (sent message echo)
        if (senderId === userId) {
            displayMessage(messageData);
        }
    }

    // Add user to inbox
    function addToInbox(userId, messageData, isReceived = false) {
        // Get user data from active list or create basic user object
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);
        let userData;

        if (userItem) {
            const userName = userItem.querySelector('.user-name').textContent;
            const genderIcon = userItem.querySelector('.gender-icon');
            const country = userItem.querySelector('.user-info-small span:last-child').textContent;

            userData = {
                userId: userId,
                userName: userName,
                gender: genderIcon.classList.contains('fa-venus') ? 'FEMALE' : 'MALE',
                country: country,
                status: 'online' // All active users should be online
            };
        } else {
            // Create basic user data if not found in active list
            userData = {
                userId: userId,
                userName: `User ${userId}`,
                gender: 'MALE',
                country: 'Unknown',
                status: 'online' // Default to online for inbox users
            };
        }

        // Add or update in inbox
        if (!inboxUsers.has(userId)) {
            inboxUsers.set(userId, {
                userData: userData,
                unread: isReceived ? 1 : 0,
                hasUnread: isReceived
            });
        } else {
            const existing = inboxUsers.get(userId);
            if (isReceived) {
                existing.unread = (existing.unread || 0) + 1;
                existing.hasUnread = true;
            }
            // Update user data in case it changed
            existing.userData = userData;
        }

        // Update inbox tab indicator only for received messages
        if (isReceived) {
            inboxUnreadCount++;
            updateInboxTabIndicator();
        }

        // Refresh inbox list if active
        if (activeTab === 'inbox') {
            refreshInboxList();
        }
    }

    // Update inbox tab indicator
    function updateInboxTabIndicator() {
        const indicator = document.getElementById('inboxTabIndicator');
        const hasUnread = inboxUnreadCount > 0;

        if (hasUnread) {
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    }

    // Create user list item with proper click handler
    function createUserListItem(user) {
        const userItem = document.createElement("li");
        userItem.className = "user-item";
        userItem.dataset.userId = user.userId;

        const genderIcon = user.gender === 'FEMALE' ? 'fas fa-venus' : 'fas fa-mars';
        const genderText = user.gender === 'FEMALE' ? 'Female' : 'Male';

        // All users from active users list should be online
        const statusClass = user.status === 'online' ? '' : 'offline';
        const statusText = user.status === 'online' ? 'Online' : 'Offline';

        userItem.innerHTML = `
            <div class="user-avatar">${user.userName.charAt(0).toUpperCase()}</div>
            <div class="user-details">
                <div class="user-name">${user.userName}</div>
                <div class="user-info-small">
                    <i class="${genderIcon} gender-icon"></i>
                    <span>${genderText}</span>
                    <span>‚Ä¢</span>
                    <i class="fas fa-globe country-flag"></i>
                    <span>${user.country || 'Unknown'}</span>
                </div>
                <div class="user-status">
                    <span class="status-indicator ${statusClass}"></span>
                    ${statusText}
                </div>
            </div>
        `;

        userItem.addEventListener('click', function() {
            selectUser(user);
        });

        return userItem;
    }

    // Select a user (called when user is clicked)
    function selectUser(user) {
        // Remove active class from all users in both lists
        document.querySelectorAll('.user-item').forEach(item => {
            item.classList.remove('active');
        });

        // Add active class to this user
        const clickedUserItem = document.querySelector(`[data-user-id="${user.userId}"]`);
        if (clickedUserItem) {
            clickedUserItem.classList.add('active');
        }

        // Store the currently selected user ID
        currentlySelectedUserId = user.userId;

        setCurrentChatUser(user);
        loadChatHistory(user.userId);

        // Clear message indicators when user is selected
        clearMessageIndicators(user.userId);

        // Mark as read in inbox
        if (inboxUsers.has(user.userId)) {
            const inboxItem = inboxUsers.get(user.userId);
            if (inboxItem.hasUnread) {
                inboxUnreadCount -= inboxItem.unread;
                inboxItem.unread = 0;
                inboxItem.hasUnread = false;
                updateInboxTabIndicator();
                refreshInboxList();
            }
        }
    }

    // Refresh inbox list
    function refreshInboxList() {
        const inboxList = document.getElementById('inboxList');
        inboxList.innerHTML = '';

        if (inboxUsers.size === 0) {
            inboxList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No conversations yet</p>
                    <p style="font-size: 0.7rem; margin-top: 5px;">Start chatting to see users here</p>
                </div>
            `;
            return;
        }

        // Convert Map to array and sort by last activity
        const inboxArray = Array.from(inboxUsers.values());

        inboxArray.forEach(inboxItem => {
            const user = inboxItem.userData;
            const userItem = createUserListItem(user);

            // Add message indicator for unread messages
            if (inboxItem.hasUnread && inboxItem.unread > 0) {
                let indicator = document.createElement('div');
                indicator.className = 'message-indicator';
                if (inboxItem.unread > 1) {
                    indicator.textContent = inboxItem.unread > 9 ? '9+' : inboxItem.unread;
                    indicator.className = 'message-indicator with-count';
                    indicator.setAttribute('data-count', inboxItem.unread);
                }
                indicator.style.display = 'flex';
                userItem.querySelector('.user-avatar').appendChild(indicator);
            }

            // If this user is currently selected, mark it as active
            if (user.userId === currentlySelectedUserId) {
                userItem.classList.add('active');
            }

            inboxList.appendChild(userItem);
        });
    }

    // Switch between active users and inbox tabs
    function setupTabSwitching() {
        const tabs = document.querySelectorAll('.sidebar-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;

                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show/hide tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + 'Tab').classList.add('active');

                activeTab = tabName;

                // Refresh the list when switching tabs
                if (tabName === 'inbox') {
                    refreshInboxList();
                }

                // Apply current filters to the active tab
                filterUsers();
            });
        });
    }

    // Setup search and filter functionality
    function setupSearchAndFilter() {
        const searchInput = document.getElementById('userSearch');
        const genderFilter = document.getElementById('genderFilter');
        const countryFilter = document.getElementById('countryFilter');

        function filterUsers() {
            const searchTerm = searchInput.value.toLowerCase();
            const genderValue = genderFilter.value;
            const countryValue = countryFilter.value.toLowerCase();

            const currentListId = activeTab === 'active' ? 'userList' : 'inboxList';
            const userItems = document.querySelectorAll(`#${currentListId} .user-item`);

            userItems.forEach(item => {
                const userName = item.querySelector('.user-name').textContent.toLowerCase();
                const userGender = item.querySelector('.gender-icon').className.includes('fa-venus') ? 'FEMALE' : 'MALE';
                const userCountry = item.querySelector('.user-info-small span:last-child').textContent.toLowerCase();

                const matchesSearch = userName.includes(searchTerm);
                const matchesGender = !genderValue || userGender === genderValue;
                const matchesCountry = !countryValue || userCountry.includes(countryValue);

                if (matchesSearch && matchesGender && matchesCountry) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('input', filterUsers);
        genderFilter.addEventListener('change', filterUsers);
        countryFilter.addEventListener('input', filterUsers);
    }

    // Function to move user to top of the list
    function moveUserToTop(userId) {
        const userList = document.getElementById("userList");
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);

        if (userItem && userList.firstChild !== userItem) {
            // Remove the user from current position
            userItem.remove();

            // Insert at the top of the list
            userList.insertBefore(userItem, userList.firstChild);

            console.log("‚úÖ Moved user to top:", userId);
        }
    }

    // Show message indicator for a user
    function showMessageIndicator(senderId) {
        // Update unread count (only for received messages)
        if (!unreadMessages[senderId]) {
            unreadMessages[senderId] = 0;
        }
        unreadMessages[senderId]++;

        // Find the user item in sidebar
        const userItem = document.querySelector(`[data-user-id="${senderId}"]`);
        if (userItem) {
            let indicator = userItem.querySelector('.message-indicator');

            if (!indicator) {
                // Create indicator if it doesn't exist
                indicator = document.createElement('div');
                indicator.className = 'message-indicator';
                userItem.querySelector('.user-avatar').appendChild(indicator);
            }

            // Update indicator with count
            const count = unreadMessages[senderId];
            if (count > 1) {
                indicator.textContent = count > 9 ? '9+' : count;
                indicator.className = 'message-indicator with-count';

                // Add data attribute for special styling
                indicator.setAttribute('data-count', count);
            } else {
                indicator.textContent = '';
                indicator.className = 'message-indicator';
            }

            indicator.style.display = 'flex';

            // Add "New Message" label for first message
            if (unreadMessages[senderId] === 1) {
                const newLabel = document.createElement('div');
                newLabel.className = 'new-message-label';
                newLabel.textContent = 'New';
                newLabel.style.display = 'block';

                // Remove existing label if any
                const existingLabel = userItem.querySelector('.new-message-label');
                if (existingLabel) {
                    existingLabel.remove();
                }

                userItem.querySelector('.user-details').appendChild(newLabel);

                // Remove label after 3 seconds
                setTimeout(() => {
                    if (newLabel.parentNode) {
                        newLabel.style.display = 'none';
                    }
                }, 3000);
            }
        }
    }

    // Clear message indicators when user is selected
    function clearMessageIndicators(userId) {
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);
        if (userItem) {
            const indicator = userItem.querySelector('.message-indicator');
            const newLabel = userItem.querySelector('.new-message-label');

            if (indicator) {
                indicator.style.display = 'none';
            }
            if (newLabel) {
                newLabel.style.display = 'none';
            }
        }

        // Reset unread count
        if (unreadMessages[userId]) {
            unreadMessages[userId] = 0;
        }
    }

    // Handle user status updates
    function handleStatusUpdate(statusUpdate) {
        console.log("üîÑ Processing status update:", statusUpdate);

        if (statusUpdate.type === "USER_STATUS_UPDATE") {
            if (statusUpdate.status === "ONLINE") {
                // User came online - add to list regardless of existing
                const existingUser = document.querySelector(`[data-user-id="${statusUpdate.userId}"]`);

                if (!existingUser) {
                    // User doesn't exist in list, add them
                    addUserToList({
                        userId: statusUpdate.userId,
                        userName: statusUpdate.userName,
                        status: "online",
                        gender: statusUpdate.gender || "MALE",
                        country: statusUpdate.country || 'Unknown'
                    });
                    console.log("‚úÖ Added new user from status update:", statusUpdate.userName);
                } else {
                    // User exists, just update status
                    updateUserStatus(statusUpdate.userId, "online");
                }
            } else if (statusUpdate.status === "OFFLINE") {
                // User went offline
                updateUserStatus(statusUpdate.userId, "offline");
            }
        }
    }

    // Add user to sidebar list
    function addUserToList(user) {
        // Skip if it's current user
        if (user.userId == userId) {
            console.log("‚è© Skipping current user:", user.userName);
            return;
        }

        const existingUser = document.querySelector(`[data-user-id="${user.userId}"]`);
        if (existingUser) {
            console.log("‚è© User already exists, updating status:", user.userName);
            updateUserStatus(user.userId, "online");
            return;
        }

        const userList = document.getElementById("userList");

        // Ensure user has online status since they're from active users list
        if (!user.status) {
            user.status = 'online';
        }

        const userItem = createUserListItem(user);

        // Add new user to the TOP of the list
        userList.insertBefore(userItem, userList.firstChild);
        console.log("‚úÖ Added NEW user to top of list:", user.userName);

        // If this is the first user, automatically select them
        if (userList.children.length === 1 && !currentlySelectedUserId) {
            selectUser(user);
        }
    }

    // Update user status in sidebar
    function updateUserStatus(userId, status) {
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);
        if (userItem) {
            const statusElement = userItem.querySelector('.user-status');
            const indicator = userItem.querySelector('.status-indicator');

            if (status === "online") {
                statusElement.innerHTML = '<span class="status-indicator"></span> Online';
                if (indicator) {
                    indicator.style.backgroundColor = '#4CAF50';
                    indicator.classList.remove('offline');
                }
            } else {
                statusElement.innerHTML = '<span class="status-indicator offline"></span> Offline';
                if (indicator) {
                    indicator.style.backgroundColor = '#ccc';
                    indicator.classList.add('offline');
                }
            }
            console.log("‚úÖ Updated user status:", userId, status);
        }

        // Also update status in inbox if user exists there
        if (inboxUsers.has(userId)) {
            const inboxItem = inboxUsers.get(userId);
            inboxItem.userData.status = status;
            if (activeTab === 'inbox') {
                refreshInboxList();
            }
        }
    }

    // Send message function - SIMPLIFIED AND FIXED
    function sendMessage() {
        const msgBox = document.getElementById("messageInput");
        const msg = msgBox.value.trim();

        if (!msg || !currentlySelectedUserId) {
            alert("Please select a user and type a message!");
            return;
        }

        const receiverId = currentlySelectedUserId;

        const messageRequest = {
            msg: msg,
            receiverId: parseInt(receiverId),
            senderId: userId
        };

        console.log("üì§ Sending message to:", receiverId);

        if (stompClient && isWebSocketConnected) {
            try {
                stompClient.send("/app/chat.send", {}, JSON.stringify(messageRequest));
                console.log("‚úÖ Message sent");

                // Add to inbox (for sent messages - but no red dot)
                addToInbox(parseInt(receiverId), messageRequest, false);

                // Move the receiver to top of the list
                moveUserToTop(parseInt(receiverId));

                msgBox.value = "";
                msgBox.style.height = 'auto';

                // The user remains selected because we're using currentlySelectedUserId

            } catch (error) {
                console.error("‚ùå Error sending message:", error);
            }
        } else {
            console.error("‚ùå WebSocket not connected");
            connectWebSocket();
        }
    }

    // Display message in chat
    function displayMessage(messageData) {
        const messages = document.getElementById("messages");
        const senderId = parseInt(messageData.senderId);

        // Determine if message should be displayed
        const shouldDisplay =
            senderId === userId ||
            (senderId === currentlySelectedUserId && parseInt(messageData.receiverId) === userId);

        if (shouldDisplay) {
            // Clear "no chat" message if it exists
            if (messages.querySelector('.no-chat')) {
                messages.innerHTML = '';
            }

            const newMsg = document.createElement("div");
            const isFromYou = senderId === userId;
            newMsg.className = isFromYou ? "message sent" : "message received";

            // Format timestamp
            let timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            newMsg.innerHTML = `
                <div class="message-bubble">${messageData.msg}</div>
                <div class="message-time">${timeString}</div>
            `;
            messages.appendChild(newMsg);
            messages.scrollTop = messages.scrollHeight;
        }
    }

    // Fetch active users from server
    function fetchActiveUsers() {
        fetch(`${userApiUrl}/find-by-status/online`, {
            method: "GET",
            credentials: "include"
        })
        .then(response => response.json())
        .then(users => {
            console.log('üë• Active users:', users);

            // Add online status to all users since they're from the online endpoint
            const usersWithStatus = users.map(user => ({
                ...user,
                status: 'online'
            }));

            populateUserList(usersWithStatus);
        })
        .catch(error => {
            console.error('Error fetching users:', error);
            populateUserListWithMockData();
        });
    }

    // Populate user list initially
    function populateUserList(users) {
        const userList = document.getElementById("userList");
        userList.innerHTML = '';

        if (users.length === 0) {
            userList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>No active users found</p>
                </div>
            `;
            return;
        }

        users.forEach(user => {
            if (user.userId == userId) return;

            const userItem = createUserListItem(user);

            // Set first user as active by default
            if (users.indexOf(user) === 0 && !currentlySelectedUserId) {
                selectUser(user);
            }

            userList.appendChild(userItem);
        });
    }

    // Set current chat user
    function setCurrentChatUser(user) {
        currentChatUser = user;
        document.getElementById("currentChatName").textContent = user.userName;
        document.getElementById("currentChatAvatar").textContent = user.userName.charAt(0).toUpperCase();
        document.getElementById("currentChatStatus").textContent = user.status === 'online' ? 'Online' : 'Offline';
        document.getElementById("currentChatGender").textContent = user.gender === 'FEMALE' ? 'Female' : 'Male';
        document.getElementById("currentChatCountry").textContent = user.country || 'Unknown';
    }

    // Load chat history for a user
    function loadChatHistory(targetUserId) {
        console.log('üí¨ Loading chat history for user:', targetUserId);

        const messagesContainer = document.getElementById("messages");
        messagesContainer.innerHTML = '<div class="no-chat">Loading messages...</div>';

        // Fetch chat history from your endpoint
        fetch(`${chatApiUrl}/get-chat-history/${userId}/${targetUserId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(messages => {
            console.log('üìö Chat history loaded:', messages);
            displayChatHistory(messages, targetUserId);

            // Clear message indicators when loading history
            clearMessageIndicators(targetUserId);
        })
        .catch(error => {
            console.error('‚ùå Error loading chat history:', error);
            messagesContainer.innerHTML = '<div class="no-chat">No messages yet. Start the conversation!</div>';
        });
    }

    // Display chat history in the messages container
    function displayChatHistory(messages, targetUserId) {
        const messagesContainer = document.getElementById("messages");
        messagesContainer.innerHTML = '';

        if (messages.length === 0) {
            messagesContainer.innerHTML = '<div class="no-chat">No messages yet. Start the conversation!</div>';
            return;
        }

        // Sort messages by ID (smaller ID = older message)
        messages.sort((a, b) => a.id - b.id);

        messages.forEach(message => {
            const messageElement = document.createElement("div");

            // Determine if message is sent by current user or received from other user
            const isFromYou = parseInt(message.senderId) === userId;
            messageElement.className = isFromYou ? "message sent" : "message received";

            // Simple timestamp - since sentDateAndTime is null, use current time or just show message
            let timeString = message.sentTime;

            messageElement.innerHTML = `
                <div class="message-bubble">${message.msg}</div>
                <div class="message-time">${timeString}</div>
            `;
            messagesContainer.appendChild(messageElement);
        });

        // Scroll to bottom to show latest messages
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        console.log(`‚úÖ Displayed ${messages.length} messages from history in correct order`);
    }

    // Mock data fallback
    function populateUserListWithMockData() {
        const mockUsers = [
            { userId: 1, userName: "John Doe", gender: "MALE", country: "USA", status: "online" },
            { userId: 2, userName: "Jane Smith", gender: "FEMALE", country: "Canada", status: "online" }
        ];
        populateUserList(mockUsers);
    }

    // Event listeners
    function setupEventListeners() {
        document.getElementById("messageInput").addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", function() {
            if (stompClient) stompClient.disconnect();
            fetch(`${userApiUrl}/logout`, { method: "GET", credentials: "include" })
            .then(() => {
                window.location.href = "signin.html";
            });
        });

        // ADD DASHBOARD BUTTON EVENT LISTENER
        document.getElementById("dashboardBtn").addEventListener("click", function() {
            // Redirect to dashboard
            window.location.href = "dashboard.html";
        });
    }

    // Initialize app - IMPROVED VERSION
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing BlinkRandom...');

        // Initialize emoji picker first
        initializeEmojiPicker();

        checkUserSession()
            .then((userData) => {
                console.log('üéØ User session validated:', userData);
                console.log('üéØ User ID:', userId);

                // Setup UI components
                setupTabSwitching();
                setupSearchAndFilter();
                setupEventListeners();

                // Connect WebSocket first and wait for it to be ready
                return connectWebSocket();
            })
            .then(() => {
                console.log('‚úÖ WebSocket connected and subscriptions active');

                // Now fetch active users - WebSocket is ready to receive status updates
                fetchActiveUsers();

                // Start connection monitoring
                monitorConnection();

                console.log('‚úÖ BlinkRandom fully initialized');
            })
            .catch(error => {
                console.error('‚ùå Failed to initialize BlinkRandom:', error);
                // Show user-friendly error message
                alert('Failed to connect to chat service. Please refresh the page.');
            });
    });
</script>
</body>
</html>