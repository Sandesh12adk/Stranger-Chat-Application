<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StrangerBlink Video Chat | Live Video Calls with Strangers</title>
    <meta name="description" content="Experience real-time video calls with random strangers worldwide. Connect instantly through live video chat - safe, anonymous, and free!">
    <meta name="keywords" content="StrangerBlink, video chat, live video calls, random video chat, webcam chat, stranger video call, online video chat, anonymous video call">
    <meta name="author" content="Sandesh Adhikari">
    <meta name="theme-color" content="#667eea">

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="StrangerBlink Video Chat | Live Video Calls with Strangers">
    <meta property="og:description" content="Connect face-to-face with random people worldwide through live video calls. Safe, anonymous, and completely free video chatting experience!">
    <meta property="og:image" content="/images/video-chat-preview.png">
    <meta property="og:url" content="https://strangerblink.fun/video-call.html">
    <meta property="og:type" content="website">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="StrangerBlink Video Chat | Live Video Calls with Strangers">
    <meta name="twitter:description" content="Connect face-to-face with random people worldwide through live video calls. Safe, anonymous, and completely free video chatting experience!">
    <meta name="twitter:image" content="/images/video-chat-preview.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/applogo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/applogo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/applogo.png">
    <link rel="shortcut icon" href="/images/applogo.png">
    <link rel="apple-touch-icon" href="/images/applogo.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://strangerblink.fun/video-call.html">

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <!-- Google Adsense -->


    <!-- Additional Meta Tags for Video Call Page -->
    <meta name="robots" content="index, follow">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Security Headers (would be in server config, but included here for reference) -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">

    <!-- PWA Manifest (if you have one) -->
    <link rel="manifest" href="/manifest.json">

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebApplication",
            "name": "StrangerBlink Video Chat",
            "description": "Live video chat platform connecting people worldwide through random video calls",
            "url": "https://strangerblink.fun/video-call.html",
            "applicationCategory": "CommunicationApplication",
            "operatingSystem": "All",
            "permissions": "camera, microphone",
            "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "USD"
            },
            "author": {
                "@type": "Person",
                "name": "Sandesh Adhikari"
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-y: auto;
            padding: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-badge {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .dashboard-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .dashboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .video-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            position: relative;
            margin-bottom: 15px;
        }

        .video-wrapper {
            position: relative;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            aspect-ratio: 4/3;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transform: scaleX(-1); /* Mirror the video */
        }

        .video-label {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            z-index: 2;
        }

        .status-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 18px;
            z-index: 1;
        }

        .camera-off-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #2d3748;
            color: white;
            font-size: 18px;
            z-index: 1;
        }

        .camera-off-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* WhatsApp-style media controls inside video */
        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 20px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .btn-mute {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .btn-mute.active {
            background: #ff4757;
            color: white;
        }

        .btn-video {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .btn-video.active {
            background: #ff4757;
            color: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 25px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-end {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-end:disabled {
            background: #ccc;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-connected { background: #4caf50; }
        .status-connecting { background: #ff9800; }
        .status-disconnected { background: #f44336; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Optimization - IMPROVED */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
            }

            .container {
                padding: 10px;
                min-height: calc(100vh - 10px);
            }

            .header {
                padding: 12px 15px;
                margin-bottom: 10px;
                position: relative;
                z-index: 100;
            }

            .logo {
                font-size: 18px;
                max-width: 50%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .user-info {
                flex-direction: column;
                gap: 8px;
                align-items: flex-end;
            }

            .user-badge, .dashboard-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .video-container {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 10px;
                flex: 1;
                min-height: 0; /* Important for flex children */
            }

            .video-wrapper {
                aspect-ratio: 16/9;
                min-height: 0;
                flex: 1;
            }

            .video-wrapper:first-child {
                flex: 0.8;
            }

            .video-wrapper:last-child {
                flex: 1;
            }

            .video-controls {
                bottom: 15px;
                padding: 10px 16px;
                gap: 10px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .controls {
                padding: 15px;
                gap: 8px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 110px;
                flex: 1;
            }

            /* Fix connection status positioning */
            .connection-status {
                top: 10px;
                right: 10px;
                max-width: 140px;
                font-size: 12px;
                padding: 8px 12px;
                z-index: 1001;
            }

            .camera-off-icon {
                font-size: 36px;
            }

            .camera-off-overlay {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .user-info {
                flex-direction: row;
                justify-content: center;
                width: 100%;
            }

            .logo {
                max-width: 100%;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            /* Adjust video container for very small screens */
            .video-container {
                gap: 8px;
            }

            .video-wrapper {
                aspect-ratio: 4/3;
            }

            .video-controls {
                bottom: 10px;
                padding: 8px 14px;
                gap: 8px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .camera-off-icon {
                font-size: 32px;
            }

            .camera-off-overlay {
                font-size: 14px;
            }
        }

        /* Landscape mode optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 8px 10px;
                margin-bottom: 8px;
            }

            .video-container {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .video-wrapper {
                aspect-ratio: 4/3;
            }

            .controls {
                padding: 10px;
            }

            .connection-status {
                top: 5px;
                right: 5px;
                max-width: 120px;
                font-size: 11px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo">🎥 StrangerBlink Video Chat</div>
        <div class="user-info">
            <div class="user-badge" id="userBadge">Loading...</div>
            <button class="dashboard-btn" id="dashboardBtn">
                <span>📊</span> Dashboard
            </button>
        </div>
    </div>

    <div class="video-container">
        <div class="video-wrapper">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="video-label">You</div>
            <!-- Camera off overlay for local video -->
            <div class="camera-off-overlay" id="localCameraOff" style="display: none;">
                <div class="camera-off-icon">📷</div>
                <div>Your camera is off</div>
            </div>
            <!-- WhatsApp-style controls inside local video -->
            <div class="video-controls">
                <button class="control-btn btn-mute" id="muteBtn">
                    <span>🎤</span>
                </button>
                <button class="control-btn btn-video" id="videoBtn">
                    <span>📹</span>
                </button>
            </div>
            <div class="status-overlay" id="localStatus" style="display: none;">
                <div class="spinner"></div>
                <div>Initializing camera...</div>
            </div>
        </div>
        <div class="video-wrapper">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="video-label" id="partnerLabel">Stranger</div>
            <!-- Camera off overlay for remote video -->
            <div class="camera-off-overlay" id="remoteCameraOff" style="display: none;">
                <div class="camera-off-icon">📷</div>
                <div>Partner's camera is off</div>
            </div>
            <div class="status-overlay" id="remoteStatus">
                <div class="spinner"></div>
                <div>Click Next to find a partner</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-next" id="nextBtn">
            <span>⏭️</span> Next
        </button>
        <button class="btn btn-end" id="endBtn" disabled>
            <span>🛑</span> End Call
        </button>
    </div>
</div>

<div class="connection-status" id="connectionStatus">
    <span class="status-dot status-connecting"></span>
    <span>Connecting...</span>
</div>

<script>
    const WS_URL = "/videocallservice/pair-video";
    const userApiUrl = "/user/api/user";

    // Global variables
    let userName = null;
    let userId = null;
    let gender = null;
    let country = null;

    let stompClient = null;
    let isWebSocketConnected = false;
    let connectionRetryCount = 0;
    const MAX_RETRIES = 3;

    // Video call variables
    let peerConnection = null;
    let localStream = null;
    let currentPartnerId = null;
    let isInitiator = false;
    let isFindingPartner = false;

    // Media control variables
    let isAudioMuted = false;
    let isVideoOff = false;

    // WebRTC configuration
    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' }
        ],
        iceCandidatePoolSize: 10
    };

    // DOM Elements
    const elements = {
        localVideo: document.getElementById('localVideo'),
        remoteVideo: document.getElementById('remoteVideo'),
        nextBtn: document.getElementById('nextBtn'),
        endBtn: document.getElementById('endBtn'),
        muteBtn: document.getElementById('muteBtn'),
        videoBtn: document.getElementById('videoBtn'),
        dashboardBtn: document.getElementById('dashboardBtn'),
        remoteStatus: document.getElementById('remoteStatus'),
        localStatus: document.getElementById('localStatus'),
        partnerLabel: document.getElementById('partnerLabel'),
        userBadge: document.getElementById('userBadge'),
        connectionStatus: document.getElementById('connectionStatus'),
        localCameraOff: document.getElementById('localCameraOff'),
        remoteCameraOff: document.getElementById('remoteCameraOff')
    };

    // ✅ Check camera status and update overlay
    function updateCameraStatus() {
        // Check local camera status
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            const isLocalCameraOn = videoTracks.length > 0 && videoTracks[0].enabled;

            if (isLocalCameraOn) {
                elements.localCameraOff.style.display = 'none';
                elements.localVideo.style.display = 'block';
            } else {
                elements.localCameraOff.style.display = 'flex';
                elements.localVideo.style.display = 'none';
            }
        }

        // Check remote camera status
        if (elements.remoteVideo.srcObject) {
            const remoteStream = elements.remoteVideo.srcObject;
            const videoTracks = remoteStream.getVideoTracks();
            const isRemoteCameraOn = videoTracks.length > 0 && videoTracks[0].enabled;

            if (isRemoteCameraOn) {
                elements.remoteCameraOff.style.display = 'none';
                elements.remoteVideo.style.display = 'block';
            } else {
                elements.remoteCameraOff.style.display = 'flex';
                elements.remoteVideo.style.display = 'none';
            }
        }
    }

    // ✅ Monitor remote stream for camera status changes
    function monitorRemoteStream() {
        if (!elements.remoteVideo.srcObject) return;

        const remoteStream = elements.remoteVideo.srcObject;
        const videoTracks = remoteStream.getVideoTracks();

        if (videoTracks.length > 0) {
            videoTracks[0].addEventListener('mute', () => {
                console.log('🔴 Remote camera turned off');
                updateCameraStatus();
            });

            videoTracks[0].addEventListener('unmute', () => {
                console.log('🟢 Remote camera turned on');
                updateCameraStatus();
            });
        }
    }

    // ✅ 1. Check user session
    async function checkUserSession() {
        const response = await fetch(`${userApiUrl}/session-check`, {
            method: "GET",
            credentials: "include"
        });

        if (!response.ok) {
            // Redirect to signin if session is invalid
            window.location.href = "signin.html";
            throw new Error(`Session invalid (status: ${response.status})`);
        }

        const userData = await response.json();
        console.log("✅ Session valid:", userData);

        userName = userData.userName;
        userId = userData.userId;
        gender = userData.gender;
        country = userData.country;

        // Update UI
        elements.userBadge.textContent = `${userData.userName} (${userData.gender}, ${userData.age})`;

        return userData;
    }

    // ✅ 2. Connect to WebSocket and subscribe
    function connectWebSocket() {
        return new Promise((resolve, reject) => {
            if (!userId) {
                reject(new Error("userId is null"));
                return;
            }

            if (stompClient && isWebSocketConnected) {
                console.log("🔄 Disconnecting old WebSocket...");
                stompClient.disconnect();
            }

            try {
                console.log("🔌 Connecting to WebSocket:", WS_URL);

                const socket = new SockJS(WS_URL);
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                const connectionTimeout = setTimeout(() => {
                    console.error("❌ Connection timeout");
                    reject(new Error("Connection timeout"));
                }, 10000);

                stompClient.connect(
                    {
                        userId: userId.toString(),
                        userName: userName,
                        gender: gender,
                        country: country
                    },
                    function (frame) {
                        clearTimeout(connectionTimeout);
                        console.log("✅ WebSocket connected:", frame);
                        isWebSocketConnected = true;
                        connectionRetryCount = 0;
                        updateConnectionStatus('connected');

                        const privateTopic = `/content/user/${userId}`;
                        console.log("📡 Subscribing to:", privateTopic);

                        // Subscribe with message handling for video calls
                        stompClient.subscribe(privateTopic, function(message) {
                            console.log("📨 Video call message received:", message.body);
                            try {
                                const messageData = JSON.parse(message.body);
                                handleVideoCallMessage(messageData);
                            } catch (e) {
                                console.error("❌ Error parsing video call message:", e);
                            }
                        });

                        resolve(frame);
                    },
                    function (error) {
                        clearTimeout(connectionTimeout);
                        console.error("❌ WebSocket connection error:", error);
                        isWebSocketConnected = false;
                        updateConnectionStatus('disconnected');

                        connectionRetryCount++;
                        if (connectionRetryCount <= MAX_RETRIES) {
                            const delay = connectionRetryCount * 2000;
                            console.log(`🔁 Retrying in ${delay}ms...`);
                            updateConnectionStatus('retrying', `Retrying... (${connectionRetryCount}/${MAX_RETRIES})`);
                            setTimeout(() => {
                                connectWebSocket().then(resolve).catch(reject);
                            }, delay);
                        } else {
                            reject(error);
                        }
                    }
                );
            } catch (error) {
                console.error("❌ WebSocket setup failed:", error);
                reject(error);
            }
        });
    }

    // ============ VIDEO CALL FUNCTIONALITY ============

    // Setup local media stream
    async function setupLocalStream() {
        console.log("🎥 Setting up local media stream...");
        elements.localStatus.style.display = 'flex';

        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280, max: 1920 },
                    height: { ideal: 720, max: 1080 },
                    frameRate: { ideal: 30, max: 60 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    channelCount: 1
                }
            });

            elements.localVideo.srcObject = localStream;
            console.log("✅ Local media stream setup complete");

            // Monitor local stream for changes
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                videoTracks[0].addEventListener('mute', () => {
                    console.log('🔴 Local camera turned off');
                    updateCameraStatus();
                });

                videoTracks[0].addEventListener('unmute', () => {
                    console.log('🟢 Local camera turned on');
                    updateCameraStatus();
                });
            }

            // Initial camera status check
            updateCameraStatus();

        } catch (error) {
            console.error("❌ Failed to access media devices:", error);
            showNotification('Camera/microphone access required', 'error');
            throw error;
        } finally {
            elements.localStatus.style.display = 'none';
        }
    }

    // Handle video call messages
    function handleVideoCallMessage(messageData) {
        console.log(`🎥 Processing video call message type: ${messageData.type}`);

        switch (messageData.type) {
            case 'PAIR_CONNECTED':
                handlePairConnected(messageData);
                break;
            case 'PAIR_DISCONNECTED':
                handlePairDisconnected(messageData);
                break;
            case 'offer':
                handleOffer(messageData);
                break;
            case 'answer':
                handleAnswer(messageData);
                break;
            case 'candidate':
                handleCandidate(messageData);
                break;
            default:
                console.log(`⚠️ Unknown message type: ${messageData.type}`);
        }
    }

    // Handle pair connection
    function handlePairConnected(message) {
        // Prevent multiple connections
        if (currentPartnerId) {
            console.log(`⚠️ Already connected to ${currentPartnerId}, ignoring new connection`);
            return;
        }

        currentPartnerId = message.pairedUserId;
        const partnerName = message.pairedUserName || `User ${currentPartnerId}`;

        console.log(`🤝 Paired with: ${partnerName} (${currentPartnerId})`);

        elements.partnerLabel.textContent = partnerName;
        elements.endBtn.disabled = false;
        elements.remoteStatus.style.display = 'flex';
        elements.remoteStatus.innerHTML = '<div class="spinner"></div><div>Connecting video...</div>';

        showNotification(`Connected with ${partnerName}!`, 'success');

        // Determine initiator (lower user ID starts the call)
        isInitiator = userId < currentPartnerId;
        console.log(`🎭 Role: ${isInitiator ? 'Caller' : 'Callee'}`);

        initializeWebRTC();

        if (isInitiator) {
            console.log('📞 Creating offer as caller');
            setTimeout(() => createOffer(), 1000);
        }
    }

    // Handle pair disconnection
    function handlePairDisconnected(message) {
        console.log(`🚫 Partner ${currentPartnerId} disconnected`);
        showNotification('Partner disconnected', 'info');
        cleanupConnection();
    }

    // Initialize WebRTC connection
    function initializeWebRTC() {
        console.log('🔧 Initializing WebRTC peer connection');

        cleanupWebRTC();

        peerConnection = new RTCPeerConnection(rtcConfig);

        // Add local tracks
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
            console.log(`➕ Added local ${track.kind} track`);
        });

        // Remote stream handler
        peerConnection.ontrack = (event) => {
            console.log('📹 Received remote media stream');
            if (event.streams && event.streams[0]) {
                elements.remoteVideo.srcObject = event.streams[0];
                elements.remoteStatus.style.display = 'none';
                showNotification('Video call connected!', 'success');
                console.log('✅ Video call is now active');

                // Start monitoring remote stream for camera status
                setTimeout(() => {
                    monitorRemoteStream();
                    updateCameraStatus();
                }, 1000);
            }
        };

        // ICE candidate handler
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('🧊 Generated ICE candidate');
                sendSignal({
                    type: 'candidate',
                    from: userId,
                    to: currentPartnerId,
                    candidate: event.candidate
                });
            } else {
                console.log('✅ All ICE candidates gathered');
            }
        };

        // Connection state handlers
        peerConnection.onconnectionstatechange = () => {
            const state = peerConnection.connectionState;
            console.log(`🔗 WebRTC state: ${state}`);

            switch (state) {
                case 'connected':
                    console.log('✅ WebRTC connection established');
                    elements.remoteStatus.style.display = 'none';
                    break;
                case 'disconnected':
                    console.log('⚠️ WebRTC disconnected');
                    showNotification('Connection lost', 'warn');
                    break;
                case 'failed':
                    console.log('❌ WebRTC connection failed');
                    showNotification('Connection failed', 'error');
                    break;
                case 'closed':
                    console.log('🔒 WebRTC connection closed');
                    break;
            }
        };

        // ICE connection state
        peerConnection.oniceconnectionstatechange = () => {
            console.log(`🧊 ICE state: ${peerConnection.iceConnectionState}`);
        };
    }

    // Create WebRTC offer
    async function createOffer() {
        if (!peerConnection || !currentPartnerId) return;

        try {
            console.log('📤 Creating WebRTC offer');
            const offer = await peerConnection.createOffer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });

            await peerConnection.setLocalDescription(offer);
            console.log('✅ Local description set');

            sendSignal({
                type: 'offer',
                from: userId,
                to: currentPartnerId,
                sdp: offer
            });

            console.log('✅ Offer sent successfully');
        } catch (error) {
            console.error('❌ Offer creation failed:', error);
        }
    }

    // Handle incoming offer
    async function handleOffer(message) {
        if (!peerConnection || !currentPartnerId) return;

        try {
            console.log('📥 Processing incoming offer');
            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));

            const answer = await peerConnection.createAnswer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });

            await peerConnection.setLocalDescription(answer);
            console.log('✅ Answer created');

            sendSignal({
                type: 'answer',
                from: userId,
                to: message.from,
                sdp: answer
            });

            console.log('✅ Answer sent successfully');
        } catch (error) {
            console.error('❌ Offer handling failed:', error);
        }
    }

    // Handle incoming answer
    async function handleAnswer(message) {
        if (!peerConnection) return;

        try {
            console.log('📥 Processing incoming answer');
            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
            console.log('✅ Answer processed successfully');
        } catch (error) {
            console.error('❌ Answer handling failed:', error);
        }
    }

    // Handle ICE candidate
    async function handleCandidate(message) {
        if (!peerConnection) return;

        try {
            console.log('🧊 Adding ICE candidate');
            await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
        } catch (error) {
            console.error('❌ Candidate addition failed:', error);
        }
    }

    // Send signal through WebSocket
    function sendSignal(signal) {
        if (stompClient?.connected) {
            try {
                stompClient.send(
                    "/application/signalmessage.send",
                    {},
                    JSON.stringify(signal)
                );
                console.log(`📤 Sent ${signal.type} to ${signal.to}`);
                return true;
            } catch (error) {
                console.error('❌ Error sending signal:', error);
                return false;
            }
        } else {
            console.error('❌ Cannot send signal - WebSocket disconnected');
            return false;
        }
    }

    // ============ MEDIA CONTROLS ============

    // Toggle audio mute/unmute
    function toggleAudio() {
        if (!localStream) return;

        const audioTracks = localStream.getAudioTracks();
        if (audioTracks.length > 0) {
            isAudioMuted = !isAudioMuted;
            audioTracks[0].enabled = !isAudioMuted;

            // Update button appearance
            if (isAudioMuted) {
                elements.muteBtn.innerHTML = '<span>🔇</span>';
                elements.muteBtn.classList.add('active');
                showNotification('Microphone muted', 'info');
            } else {
                elements.muteBtn.innerHTML = '<span>🎤</span>';
                elements.muteBtn.classList.remove('active');
                showNotification('Microphone unmuted', 'info');
            }

            console.log(`🔊 ${isAudioMuted ? 'Muted' : 'Unmuted'} audio`);
        }
    }

    // Toggle video on/off
    function toggleVideo() {
        if (!localStream) return;

        const videoTracks = localStream.getVideoTracks();
        if (videoTracks.length > 0) {
            isVideoOff = !isVideoOff;
            videoTracks[0].enabled = !isVideoOff;

            // Update button appearance
            if (isVideoOff) {
                elements.videoBtn.innerHTML = '<span>🚫</span>';
                elements.videoBtn.classList.add('active');
                showNotification('Video turned off', 'info');
            } else {
                elements.videoBtn.innerHTML = '<span>📹</span>';
                elements.videoBtn.classList.remove('active');
                showNotification('Video turned on', 'info');
            }

            console.log(`📹 ${isVideoOff ? 'Turned off' : 'Turned on'} video`);

            // Update camera status display
            updateCameraStatus();
        }
    }

    // ============ UI CONTROLS ============

    // Next button handler
    async function handleNextClick() {
        // Prevent multiple clicks
        if (isFindingPartner) {
            console.log('⏳ Already searching for partner...');
            return;
        }

        // Prevent Next when connected
        if (currentPartnerId) {
            console.log('⚠️ Already connected to partner, use "End Call" first');
            showNotification('Already connected to a partner. Use "End Call" first.', 'warn');
            return;
        }

        console.log('🔍 Finding next partner');
        isFindingPartner = true;
        elements.nextBtn.disabled = true;
        elements.nextBtn.innerHTML = '<span>⏳</span> Searching...';

        try {
            const response = await fetch(`/videocallservice/next/${userId}`, {
                method: 'POST',
                credentials: 'include'
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            console.log('Next response:', data);

            if (data.partnerId) {
                console.log(`✅ Immediate partner found: ${data.partnerId}`);
                showNotification('Partner found! Connecting...', 'success');
            } else {
                elements.remoteStatus.style.display = 'flex';
                elements.remoteStatus.innerHTML = '<div class="spinner"></div><div>Searching for partner...</div>';
                console.log('⏳ Waiting for partner in queue');
                showNotification('Searching for partner...', 'info');
            }
        } catch (error) {
            console.error('❌ Next request failed:', error);
            showNotification('Failed to find partner', 'error');
        } finally {
            setTimeout(() => {
                elements.nextBtn.disabled = false;
                elements.nextBtn.innerHTML = '<span>⏭️</span> Next';
                isFindingPartner = false;
            }, 3000);
        }
    }

    // End call button handler
    async function handleEndClick() {
        if (!currentPartnerId) {
            console.log('⚠️ No active call to end');
            return;
        }

        console.log('📞 Ending current call with partner:', currentPartnerId);
        elements.endBtn.disabled = true;
        elements.endBtn.innerHTML = '<span>⏳</span> Ending...';

        try {
            const response = await fetch(`/videocallservice/skip/${userId}`, {
                method: 'POST',
                credentials: 'include'
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            console.log('✅ Call ended successfully');
            showNotification('Call ended', 'info');
            cleanupConnection();
        } catch (error) {
            console.error('❌ End call failed:', error);
            showNotification('Failed to end call', 'error');
        } finally {
            elements.endBtn.disabled = false;
            elements.endBtn.innerHTML = '<span>🛑</span> End Call';
        }
    }

    // Dashboard button handler
    async function handleDashboardClick() {
        // End current call if active
        if (currentPartnerId) {
            console.log('📞 Ending call before navigating to dashboard');
            try {
                await fetch(`/videocallservice/skip/${userId}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                console.log('✅ Call ended before dashboard navigation');
            } catch (error) {
                console.error('❌ Error ending call before dashboard:', error);
            }
        }

        // Navigate to dashboard
        window.location.href = "dashboard.html";
    }

    // Cleanup connection
    function cleanupConnection() {
        console.log('🧹 Cleaning up connection');
        isFindingPartner = false;

        cleanupWebRTC();

        elements.remoteVideo.srcObject = null;
        elements.remoteStatus.style.display = 'flex';
        elements.remoteStatus.innerHTML = '<div class="spinner"></div><div>Click Next to find a partner</div>';
        elements.partnerLabel.textContent = 'Stranger';
        elements.endBtn.disabled = true;

        // Hide camera off overlays
        elements.remoteCameraOff.style.display = 'none';
        elements.remoteVideo.style.display = 'block';

        // Reset next button
        elements.nextBtn.disabled = false;
        elements.nextBtn.innerHTML = '<span>⏭️</span> Next';

        currentPartnerId = null;
        isInitiator = false;
    }

    // Cleanup WebRTC
    function cleanupWebRTC() {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
            console.log('✅ WebRTC connection cleaned up');
        }
    }

    // ============ UTILITY FUNCTIONS ============

    // Update connection status
    function updateConnectionStatus(status, message = '') {
        const statusMap = {
            connected: { text: 'Connected', class: 'status-connected' },
            connecting: { text: 'Connecting...', class: 'status-connecting' },
            disconnected: { text: 'Disconnected', class: 'status-disconnected' },
            retrying: { text: message || 'Retrying...', class: 'status-connecting' }
        };

        const statusInfo = statusMap[status] || statusMap.disconnected;
        elements.connectionStatus.innerHTML = `
            <span class="status-dot ${statusInfo.class}"></span>
            <span>${statusInfo.text}</span>
        `;
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.background =
            type === 'error' ? '#f44336' :
            type === 'success' ? '#4caf50' :
            type === 'warn' ? '#ff9800' : '#2196f3';
        notification.style.color = 'white';

        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
        elements.nextBtn.addEventListener('click', handleNextClick);
        elements.endBtn.addEventListener('click', handleEndClick);
        elements.muteBtn.addEventListener('click', toggleAudio);
        elements.videoBtn.addEventListener('click', toggleVideo);
        elements.dashboardBtn.addEventListener('click', handleDashboardClick);

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (currentPartnerId) {
                navigator.sendBeacon(`/videocallservice/skip/${userId}`);
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (stompClient) {
                stompClient.disconnect();
            }
        });
    }

    // Initialize application on page load
    async function initializeApp() {
        console.log('🚀 Initializing application...');

        try {
            // Setup event listeners first
            setupEventListeners();

            // Check user session
            await checkUserSession();

            // Setup local media
            await setupLocalStream();

            // Connect to WebSocket
            await connectWebSocket();

            console.log('✅ Application initialized successfully');

        } catch (error) {
            console.error('❌ Application initialization failed:', error);
            showNotification('Failed to initialize application', 'error');
        }
    }

    // Execute on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });
</script>
</body>
</html>