<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StrangerBlink Dashboard | Chat Instantly</title>
    <meta name="description" content="Connect instantly with random strangers worldwide. Start chatting safely and anonymously!">
    <meta name="keywords" content="StrangerBlink, dashboard, anonymous chat, random chat, online chat, instant messaging, connect with strangers">
    <meta name="author" content="Sandesh Adhikari">
    <meta name="theme-color" content="#4361ee">
    <meta property="og:title" content="StrangerBlink Dashboard | Chat Instantly">
    <meta property="og:description" content="Access your StrangerBlink Dashboard and start chatting safely with people worldwide. Anonymous and instant conversations!">
    <meta property="og:image" content="/images/applogo.png">
    <meta property="og:url" content="https://strangerblink.fun/dashboard.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="StrangerBlink Dashboard | Chat Instantly">
    <meta name="twitter:description" content="Access your StrangerBlink Dashboard and start chatting safely with people worldwide. Anonymous and instant conversations!">
    <meta name="twitter:image" content="/images/applogo.png">
    <link rel="icon" type="image/png" href="/images/applogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="canonical" href="https://strangerblink.fun/dashboard.html">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --border-radius: 10px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            position: fixed;
            width: 100%;
            touch-action: pan-y;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            max-width: 1600px;
            margin: 0 auto;
            box-shadow: var(--shadow);
            background-color: white;
            position: relative;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo i {
            font-size: 1.3rem;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.9rem;
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.85rem;
        }

        #dashboardBtn {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        #dashboardBtn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #logoutBtn {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        #logoutBtn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Mobile Header Controls */
        .mobile-header-controls {
            display: flex;
            gap: 8px;
        }

        .mobile-menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 38px;
            height: 38px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
        }

        /* Main Content */
        .chat-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 19;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 100%;
            max-width: 320px;
            background: var(--light);
            border-right: 1px solid var(--light-gray);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 20;
            transform: translateX(-100%);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            background: white;
            flex-shrink: 0;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 600;
            font-size: 0.95rem;
            position: relative;
        }

        .sidebar-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: var(--light);
        }

        .tab-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            display: none;
        }

        .tab-indicator.active {
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .search-container {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
            background: white;
            flex-shrink: 0;
        }

        .search-box {
            position: relative;
            margin-bottom: 8px;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 38px;
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .filter-options {
            display: flex;
            gap: 8px;
        }

        .filter-select {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-list {
            list-style: none;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 8px;
            position: relative;
            background: white;
        }

        .user-item:active {
            transform: scale(0.98);
        }

        .user-item.active {
            background: #e3f2fd;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            position: relative;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            position: relative;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 1rem;
        }

        .user-info-small {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-status {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 2px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.offline {
            background: var(--gray);
        }

        .gender-icon {
            font-size: 0.75rem;
        }

        .country-flag {
            font-size: 0.8rem;
        }

        .message-indicator {
            position: absolute;
            top: -3px;
            right: -3px;
            min-width: 22px;
            height: 22px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s infinite;
            display: none;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(247, 37, 133, 0.4);
        }

        .message-indicator.with-count {
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 900;
            color: white;
            background: linear-gradient(135deg, var(--danger) 0%, #d4145a 100%);
            padding: 0 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            width: 100%;
            min-width: 0;
        }

        .chat-header {
            padding: 12px 15px;
            background: white;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .current-chat-user {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .current-chat-user .user-avatar {
            width: 44px;
            height: 44px;
            font-size: 1.1rem;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-info h3 {
            font-size: 1.05rem;
            margin: 0 0 3px 0;
            font-weight: 600;
        }

        .chat-info p {
            font-size: 0.8rem;
            color: var(--gray);
            margin: 0 0 3px 0;
        }

        .user-details-extended {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .user-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .block-btn {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
            border: 1px solid rgba(247, 37, 133, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .block-btn:active {
            transform: scale(0.95);
        }

        .block-btn.blocked {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
            border-color: rgba(76, 201, 240, 0.3);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f7fa;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .no-chat {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
            font-size: 1rem;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 1.1rem; /* Increased font size for mobile */
            line-height: 1.4;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            color: var(--dark);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 4px;
            padding: 0 4px;
        }

        .blocked-message {
            text-align: center;
            padding: 12px;
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .system-notification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: top 0.3s ease;
            max-width: 90%;
        }

        .system-notification.show {
            top: 20px;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .notification-content i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid var(--light-gray);
            background: white;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-actions button {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .input-actions button:active {
            background: var(--light-gray);
            transform: scale(0.95);
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 25px;
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
            font-family: inherit;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-button {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .send-button:active {
            transform: scale(0.95);
        }

        /* Emoji Picker */
        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 15px;
            right: 15px;
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 15px;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            margin-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .emoji-picker.active {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(42px, 1fr));
            gap: 8px;
        }

        .emoji {
            font-size: 1.8rem;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition);
            user-select: none;
        }

        .emoji:active {
            background: var(--light-gray);
            transform: scale(1.2);
        }

        /* Desktop Styles */
        @media (min-width: 769px) {
            .mobile-header-controls {
                display: none !important;
            }

            .sidebar {
                position: static;
                transform: translateX(0);
                width: 320px;
            }

            .sidebar-overlay {
                display: none !important;
            }

            .sidebar-close {
                display: none;
            }

            #dashboardBtn,
            #logoutBtn {
                display: flex;
            }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            header {
                padding: 10px 12px;
            }

            .logo span {
                display: none;
            }

            .user-info span {
                display: none;
            }

            #dashboardBtn,
            #logoutBtn {
                display: none;
            }

            .mobile-header-controls {
                display: flex !important;
            }

            .message {
                max-width: 85%;
            }

            .message-bubble {
                font-size: 1.15rem; /* Even larger on mobile */
            }
        }

        /* Small mobile devices */
        @media (max-width: 360px) {
            .message-bubble {
                font-size: 1.05rem;
                padding: 10px 14px;
            }

            .user-avatar {
                width: 38px;
                height: 38px;
                font-size: 0.95rem;
            }
        }
        .new-message-label {
    position: absolute;
    top: -2px;
    right: 0;
    background: var(--danger);
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: bold;
    display: none;
}
    </style>
</head>
<body>
<div class="app-container">
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <span>Strangerblink</span>
        </div>
        <div class="profile">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <span id="username">User</span>
            </div>
            <button id="dashboardBtn">
                <i class="fas fa-arrow-left"></i>
                Dashboard
            </button>
            <button id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
            <div class="mobile-header-controls">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="chat-container">
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Connect with People</h3>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="active">
                    <span>Active Users</span>
                    <div class="tab-indicator" id="activeTabIndicator"></div>
                </div>
                <div class="sidebar-tab" data-tab="inbox">
                    <span>Inbox</span>
                    <div class="tab-indicator" id="inboxTabIndicator"></div>
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="userSearch" class="search-input" placeholder="Search users...">
                </div>
                <div class="filter-options">
                    <select id="genderFilter" class="filter-select">
                        <option value="">All Genders</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                    <input type="text" id="countryFilter" class="filter-input" placeholder="Country...">
                </div>
            </div>

            <div class="sidebar-content">
                <div class="tab-content active" id="activeTab">
                    <div class="sidebar-section">
                        <ul class="user-list" id="userList"></ul>
                    </div>
                </div>

                <div class="tab-content" id="inboxTab">
                    <div class="sidebar-section">
                        <ul class="user-list" id="inboxList"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="current-chat-user">
                    <div class="user-avatar" id="currentChatAvatar">JD</div>
                    <div class="chat-info">
                        <h3 id="currentChatName">John Doe</h3>
                        <p id="currentChatStatus">Online - Last seen just now</p>
                        <div class="user-details-extended">
                            <div class="user-detail">
                                <i class="fas fa-venus-mars gender-icon"></i>
                                <span id="currentChatGender">Male</span>
                            </div>
                            <div class="user-detail">
                                <i class="fas fa-globe country-flag"></i>
                                <span id="currentChatCountry">USA</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-actions" id="chatActions" style="display: none;">
                    <button class="block-btn" id="blockUserBtn">
                        <i class="fas fa-ban"></i>
                        <span>Block</span>
                    </button>
                </div>
            </div>

            <div class="messages" id="messages">
                <div class="no-chat">Select a user to start chatting</div>
            </div>

            <div class="input-area">
                <div class="input-actions">
                    <button id="emojiButton"><i class="fas fa-smile"></i></button>
                    <button><i class="fas fa-image"></i></button>
                </div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                    <button class="send-button" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="emoji-picker" id="emojiPicker"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Separate URLs for different microservices
 const userApiUrl = "/user/api/user"; //UserBase URL
 const chatApiUrl = "/chat"; // Chat Service base URL

 // Global variables
 let stompClient = null;
 let isWebSocketConnected = false;
 let userName = null;
 let userId = null;
 let unreadMessages = {}; // Track unread messages per user
 let currentChatUser = null; // Track currently open chat
 let gender = null;
 let country = null;
 let connectionRetryCount = 0;
 const MAX_RETRIES = 3;
 let activeTab = 'active'; // 'active' or 'inbox'
 let inboxUsers = new Map(); // Track users in inbox: {userId: {userData, unread}}
 let inboxUnreadCount = 0; // Total unread messages in inbox
 let currentlySelectedUserId = null; // Track currently selected user ID
 let isBlockedStatus = false; // Track if current chat user is blocked

 // Emoji data
 const emojis = [
     'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
     'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
     'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
     'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
     'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
     'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
     'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ',
     'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
     'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà',
     'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ',
     'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø',
     'üòæ', 'üíã', 'üíå', 'üíò', 'üíù', 'üíñ', 'üíó', 'üíì', 'üíû', 'üíï',
     'üíü', '‚ù£Ô∏è', 'üíî', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§',
     'ü§ç', 'ü§é', 'üíØ', '‚ú®', 'üåü', '‚≠ê', 'üî•', 'üí•', 'üëç', 'üëé'
 ];

    // Handle browser back button and navigation
    function setupBackButtonHandler() {
        // Add a state to history when page loads
        window.history.pushState({page: 'chat'}, '', '');

        // Handle back button press
        window.addEventListener('popstate', function(event) {
            console.log('üîô Back button pressed');
            handleUserGoingOffline();
            window.location.href = "dashboard.html";
        });

        // Handle page unload (including refresh and close)
        window.addEventListener('beforeunload', function(event) {
            console.log('üö™ Page unloading');
            handleUserGoingOffline();
        });

        // Handle visibility change (tab switch, minimize, etc.)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('üëÅÔ∏è Page hidden');
                // Optionally handle when page is hidden
            } else {
                console.log('üëÅÔ∏è Page visible');
                // Optionally reconnect if needed
            }
        });
    }

    // Handle user going offline
    function handleUserGoingOffline() {
        if (stompClient && isWebSocketConnected) {
            console.log('üì° Disconnecting WebSocket...');
            try {
                stompClient.disconnect(() => {
                    console.log('‚úÖ WebSocket disconnected');
                });
            } catch (error) {
                console.error('‚ùå Error disconnecting WebSocket:', error);
            }
        }
    }

    // Prevent keyboard from closing on send
    function setupKeyboardPersistence() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Prevent blur on send button click
        sendButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            sendMessage();
            // Keep focus on input to maintain keyboard
            setTimeout(() => {
                messageInput.focus();
            }, 10);
        });

        // Handle Enter key while keeping keyboard open
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
                // Keep focus to maintain keyboard
                setTimeout(() => {
                    messageInput.focus();
                }, 10);
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

  // Mobile sidebar controls
    function setupMobileControls() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarClose = document.getElementById('sidebarClose');

        if (mobileMenuBtn && sidebar && sidebarOverlay) {
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            });

            sidebarClose.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && e.target.closest('.user-item')) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            });
        }
    }


 // Initialize emoji picker with scrolling
 function initializeEmojiPicker() {
     const emojiPicker = document.getElementById('emojiPicker');
     const emojiButton = document.getElementById('emojiButton');

     // Clear any existing emojis
     emojiPicker.innerHTML = '';

     // Populate emoji picker with all emojis
     emojis.forEach(emoji => {
         const emojiElement = document.createElement('span');
         emojiElement.className = 'emoji';
         emojiElement.textContent = emoji;
         emojiElement.title = emoji;
         emojiElement.addEventListener('click', () => {
             insertEmoji(emoji);
         });
         emojiPicker.appendChild(emojiElement);
     });

     // Toggle emoji picker visibility
     emojiButton.addEventListener('click', (e) => {
         e.preventDefault();
         e.stopPropagation();
         emojiPicker.classList.toggle('active');

         // Scroll to top when opening
         if (emojiPicker.classList.contains('active')) {
             emojiPicker.scrollTop = 0;
         }
     });

     // Close emoji picker when clicking outside
     document.addEventListener('click', (e) => {
         if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
             emojiPicker.classList.remove('active');
         }
     });

     // Prevent emoji picker from closing when scrolling inside it
     emojiPicker.addEventListener('click', (e) => {
         e.stopPropagation();
     });

     console.log('‚úÖ Emoji picker initialized with', emojis.length, 'emojis');
 }

 // Insert emoji into message input
 function insertEmoji(emoji) {
     const messageInput = document.getElementById('messageInput');
     const startPos = messageInput.selectionStart;
     const endPos = messageInput.selectionEnd;

     messageInput.value = messageInput.value.substring(0, startPos) +
                         emoji +
                         messageInput.value.substring(endPos);

     // Set cursor position after the inserted emoji
     messageInput.selectionStart = messageInput.selectionEnd = startPos + emoji.length;
     messageInput.focus();

     // Close emoji picker
     document.getElementById('emojiPicker').classList.remove('active');
 }

 // Check session and get user data
 function checkUserSession() {
     return fetch(`${userApiUrl}/session-check`, {
         method: "GET",
         credentials: "include"
     })
     .then(response => {
         if (!response.ok) throw new Error('Session invalid');
         return response.json();
     })
     .then(userData => {
         console.log('‚úÖ Session valid, user data:', userData);

         userName = userData.userName;
         userId = userData.userId;
         gender = userData.gender;
         country = userData.country;

         document.getElementById("username").textContent = userName;
         document.getElementById("userAvatar").textContent = userName.charAt(0).toUpperCase();

         return userData;
     })
     .catch(error => {
         console.error('‚ùå Session check failed:', error);
         window.location.href = "dashboard.html";
     });
 }

 // WebSocket connection with Promise
 function connectWebSocket() {
     return new Promise((resolve, reject) => {
         if (!userId) {
             console.error('‚ùå Cannot connect WebSocket: userId is null');
             reject(new Error('userId is null'));
             return;
         }

         // Clear any existing connection
         if (stompClient && isWebSocketConnected) {
             console.log('üîÑ Disconnecting existing WebSocket...');
             stompClient.disconnect();
         }

         try {
             console.log('üîå Connecting WebSocket for userId:', userId);

            const socket = new SockJS(`${chatApiUrl}/ws-chat`);
             stompClient = Stomp.over(socket);

             // Set a connection timeout
             const connectionTimeout = setTimeout(() => {
                 console.error('‚ùå WebSocket connection timeout');
                 reject(new Error('Connection timeout'));
             }, 10000);

             stompClient.connect(
                 {
                     'userId': userId.toString(),
                     'userName': userName,
                     'gender': gender,
                     'country': country
                 },
                 function(frame) {
                     clearTimeout(connectionTimeout);
                     console.log('‚úÖ WebSocket Connected');
                     isWebSocketConnected = true;
                     connectionRetryCount = 0;

                     // Subscribe to receive private messages
                     const privateTopic = "/topic/user/" + userId;
                     console.log('üì° Subscribing to private messages:', privateTopic);

                     stompClient.subscribe(privateTopic, function(message) {
                         console.log("üì® Message received:", message.body);
                         try {
                             const messageData = JSON.parse(message.body);
                             handleIncomingMessage(messageData);
                         } catch (e) {
                             console.error("‚ùå Error parsing message:", e);
                         }
                     });

                     // Subscribe to user status changes
                     const statusTopic = "/topic/status-change";
                     console.log('üì° Subscribing to status updates:', statusTopic);

                     const statusSubscription = stompClient.subscribe(statusTopic, function(message) {
                         console.log("üîÑ Status update received:", message.body);
                         try {
                             const statusUpdate = JSON.parse(message.body);
                             handleStatusUpdate(statusUpdate);
                         } catch (e) {
                             console.error("‚ùå Error parsing status update:", e);
                         }
                     });

                     resolve(frame);
                 },
                 function(error) {
                     clearTimeout(connectionTimeout);
                     console.error('‚ùå WebSocket connection error:', error);
                     isWebSocketConnected = false;

                     // Retry logic
                     if (connectionRetryCount < MAX_RETRIES) {
                         connectionRetryCount++;
                         console.log(`üîÑ Retrying connection (${connectionRetryCount}/${MAX_RETRIES})...`);
                         setTimeout(() => {
                             connectWebSocket().then(resolve).catch(reject);
                         }, 2000 * connectionRetryCount);
                     } else {
                         reject(error);
                     }
                 }
             );

         } catch (error) {
             console.error('‚ùå Error in WebSocket setup:', error);
             reject(error);
         }
     });
 }

 // Connection monitoring
 function monitorConnection() {
     setInterval(() => {
         if (!isWebSocketConnected) {
             console.log('üîÑ WebSocket disconnected, attempting reconnect...');
             connectWebSocket()
                 .then(() => console.log('‚úÖ WebSocket reconnected'))
                 .catch(error => console.error('‚ùå WebSocket reconnect failed:', error));
         }
     }, 30000);
 }

 // Handle incoming messages
 function handleIncomingMessage(messageData) {
     const senderId = parseInt(messageData.senderId);
     const messageType = messageData.type;
     console.log('üì® Processing incoming message from:', senderId, 'currently selected user:', currentlySelectedUserId);

     // Handle system messages differently
     if (messageType === 'system') {
         displaySystemMessage(messageData);
         return;
     }

     // Add to inbox users (only for received messages)
     if (senderId !== userId) {
         addToInbox(senderId, messageData, true);
     }

     // Check if message is from currently active chat
     const isFromActiveChat = senderId === currentlySelectedUserId;

     if (isFromActiveChat) {
         // Display message immediately if it's from active chat
         displayMessage(messageData);
     } else if (senderId !== userId) {
         // Show message indicator only for received messages (not sent)
         showMessageIndicator(senderId);

         // Move user to top of the list
         moveUserToTop(senderId);
     }

     // Also display if it's your own message (sent message echo)
     if (senderId === userId) {
         displayMessage(messageData);
     }
 }

 // Add user to inbox
 function addToInbox(userId, messageData, isReceived = false) {
     // Get user data from active list or create basic user object
     const userItem = document.querySelector(`[data-user-id="${userId}"]`);
     let userData;

     if (userItem) {
         const userName = userItem.querySelector('.user-name').textContent;
         const genderIcon = userItem.querySelector('.gender-icon');
         const country = userItem.querySelector('.user-info-small span:last-child').textContent;

         userData = {
             userId: userId,
             userName: userName,
             gender: genderIcon.classList.contains('fa-venus') ? 'FEMALE' : 'MALE',
             country: country,
             status: 'online'
         };
     } else {
         // Create basic user data if not found in active list
         userData = {
             userId: userId,
             userName: `User ${userId}`,
             gender: 'MALE',
             country: 'Unknown',
             status: 'online'
         };
     }

     // Add or update in inbox
     if (!inboxUsers.has(userId)) {
         inboxUsers.set(userId, {
             userData: userData,
             unread: isReceived ? 1 : 0,
             hasUnread: isReceived
         });
     } else {
         const existing = inboxUsers.get(userId);
         if (isReceived) {
             existing.unread = (existing.unread || 0) + 1;
             existing.hasUnread = true;
         }
         existing.userData = userData;
     }

     // Update inbox tab indicator only for received messages
     if (isReceived) {
         inboxUnreadCount++;
         updateInboxTabIndicator();
     }

     // Refresh inbox list if active
     if (activeTab === 'inbox') {
         refreshInboxList();
     }
 }

 // Update inbox tab indicator
 function updateInboxTabIndicator() {
     const indicator = document.getElementById('inboxTabIndicator');
     const hasUnread = inboxUnreadCount > 0;

     if (hasUnread) {
         indicator.classList.add('active');
     } else {
         indicator.classList.remove('active');
     }
 }

 // Create user list item with proper click handler
 function createUserListItem(user) {
     const userItem = document.createElement("li");
     userItem.className = "user-item";
     userItem.dataset.userId = user.userId;

     const genderIcon = user.gender === 'FEMALE' ? 'fas fa-venus' : 'fas fa-mars';
     const genderText = user.gender === 'FEMALE' ? 'Female' : 'Male';

     const statusClass = user.status === 'online' ? '' : 'offline';
     const statusText = user.status === 'online' ? 'Online' : 'Offline';

     userItem.innerHTML = `
         <div class="user-avatar">${user.userName.charAt(0).toUpperCase()}</div>
         <div class="user-details">
             <div class="user-name">${user.userName}</div>
             <div class="user-info-small">
                 <i class="${genderIcon} gender-icon"></i>
                 <span>${genderText}</span>
                 <span>‚Ä¢</span>
                 <i class="fas fa-globe country-flag"></i>
                 <span>${user.country || 'Unknown'}</span>
             </div>
             <div class="user-status">
                 <span class="status-indicator ${statusClass}"></span>
                 ${statusText}
             </div>
         </div>
     `;

     userItem.addEventListener('click', function() {
         selectUser(user);
     });

     return userItem;
 }

 // Select a user (called when user is clicked)
 function selectUser(user) {
     // Remove active class from all users in both lists
     document.querySelectorAll('.user-item').forEach(item => {
         item.classList.remove('active');
     });

     // Add active class to this user
     const clickedUserItem = document.querySelector(`[data-user-id="${user.userId}"]`);
     if (clickedUserItem) {
         clickedUserItem.classList.add('active');
     }

     // Store the currently selected user ID
     currentlySelectedUserId = user.userId;

     setCurrentChatUser(user);
     loadChatHistory(user.userId);

     // Clear message indicators when user is selected
     clearMessageIndicators(user.userId);

     // Mark as read in inbox
     if (inboxUsers.has(user.userId)) {
         const inboxItem = inboxUsers.get(user.userId);
         if (inboxItem.hasUnread) {
             inboxUnreadCount -= inboxItem.unread;
             inboxItem.unread = 0;
             inboxItem.hasUnread = false;
             updateInboxTabIndicator();
             refreshInboxList();
         }
     }
 }

 // Refresh inbox list
 function refreshInboxList() {
     const inboxList = document.getElementById('inboxList');
     inboxList.innerHTML = '';

     if (inboxUsers.size === 0) {
         inboxList.innerHTML = `
             <div class="empty-state">
                 <i class="fas fa-inbox"></i>
                 <p>No conversations yet</p>
                 <p style="font-size: 0.7rem; margin-top: 5px;">Start chatting to see users here</p>
             </div>
         `;
         return;
     }

     // Convert Map to array and sort by last activity
     const inboxArray = Array.from(inboxUsers.values());

     inboxArray.forEach(inboxItem => {
         const user = inboxItem.userData;
         const userItem = createUserListItem(user);

         // Add message indicator for unread messages
         if (inboxItem.hasUnread && inboxItem.unread > 0) {
             let indicator = document.createElement('div');
             indicator.className = 'message-indicator';
             if (inboxItem.unread > 1) {
                 indicator.textContent = inboxItem.unread > 9 ? '9+' : inboxItem.unread;
                 indicator.className = 'message-indicator with-count';
                 indicator.setAttribute('data-count', inboxItem.unread);
             }
             indicator.style.display = 'flex';
             userItem.querySelector('.user-avatar').appendChild(indicator);
         }

         // If this user is currently selected, mark it as active
         if (user.userId === currentlySelectedUserId) {
             userItem.classList.add('active');
         }

         inboxList.appendChild(userItem);
     });
 }

 // Switch between active users and inbox tabs
 function setupTabSwitching() {
     const tabs = document.querySelectorAll('.sidebar-tab');
     tabs.forEach(tab => {
         tab.addEventListener('click', function() {
             const tabName = this.dataset.tab;

             // Update active tab
             tabs.forEach(t => t.classList.remove('active'));
             this.classList.add('active');

             // Show/hide tab content
             document.querySelectorAll('.tab-content').forEach(content => {
                 content.classList.remove('active');
             });
             document.getElementById(tabName + 'Tab').classList.add('active');

             activeTab = tabName;

             // Refresh the list when switching tabs
             if (tabName === 'inbox') {
                 refreshInboxList();
             }

             // Apply current filters to the active tab
             filterUsers();
         });
     });
 }

 // Setup search and filter functionality
 function setupSearchAndFilter() {
     const searchInput = document.getElementById('userSearch');
     const genderFilter = document.getElementById('genderFilter');
     const countryFilter = document.getElementById('countryFilter');

     function filterUsers() {
         const searchTerm = searchInput.value.toLowerCase();
         const genderValue = genderFilter.value;
         const countryValue = countryFilter.value.toLowerCase();

         const currentListId = activeTab === 'active' ? 'userList' : 'inboxList';
         const userItems = document.querySelectorAll(`#${currentListId} .user-item`);

         userItems.forEach(item => {
             const userName = item.querySelector('.user-name').textContent.toLowerCase();
             const userGender = item.querySelector('.gender-icon').className.includes('fa-venus') ? 'FEMALE' : 'MALE';
             const userCountry = item.querySelector('.user-info-small span:last-child').textContent.toLowerCase();

             const matchesSearch = userName.includes(searchTerm);
             const matchesGender = !genderValue || userGender === genderValue;
             const matchesCountry = !countryValue || userCountry.includes(countryValue);

             if (matchesSearch && matchesGender && matchesCountry) {
                 item.style.display = 'flex';
             } else {
                 item.style.display = 'none';
             }
         });
     }

     searchInput.addEventListener('input', filterUsers);
     genderFilter.addEventListener('change', filterUsers);
     countryFilter.addEventListener('input', filterUsers);
 }

 // Function to move user to top of the list
 function moveUserToTop(userId) {
     const userList = document.getElementById("userList");
     const userItem = document.querySelector(`[data-user-id="${userId}"]`);

     if (userItem && userList.firstChild !== userItem) {
         userItem.remove();
         userList.insertBefore(userItem, userList.firstChild);
         console.log("‚úÖ Moved user to top:", userId);
     }
 }

 // Show message indicator for a user
 function showMessageIndicator(senderId) {
     // Update unread count (only for received messages)
     if (!unreadMessages[senderId]) {
         unreadMessages[senderId] = 0;
     }
     unreadMessages[senderId]++;

     // Find the user item in sidebar
     const userItem = document.querySelector(`[data-user-id="${senderId}"]`);
     if (userItem) {
         let indicator = userItem.querySelector('.message-indicator');

         if (!indicator) {
             indicator = document.createElement('div');
             indicator.className = 'message-indicator';
             userItem.querySelector('.user-avatar').appendChild(indicator);
         }

         // Update indicator with count
         const count = unreadMessages[senderId];
         if (count > 1) {
             indicator.textContent = count > 9 ? '9+' : count;
             indicator.className = 'message-indicator with-count';
             indicator.setAttribute('data-count', count);
         } else {
             indicator.textContent = '';
             indicator.className = 'message-indicator';
         }

         indicator.style.display = 'flex';

         // Add "New Message" label for first message
         if (unreadMessages[senderId] === 1) {
             const newLabel = document.createElement('div');
             newLabel.className = 'new-message-label';
             newLabel.textContent = 'New';
             newLabel.style.display = 'block';

             const existingLabel = userItem.querySelector('.new-message-label');
             if (existingLabel) {
                 existingLabel.remove();
             }

             userItem.querySelector('.user-details').appendChild(newLabel);

             setTimeout(() => {
                 if (newLabel.parentNode) {
                     newLabel.style.display = 'none';
                 }
             }, 3000);
         }
     }
 }

 // Clear message indicators when user is selected
 function clearMessageIndicators(userId) {
     const userItem = document.querySelector(`[data-user-id="${userId}"]`);
     if (userItem) {
         const indicator = userItem.querySelector('.message-indicator');
         const newLabel = userItem.querySelector('.new-message-label');

         if (indicator) {
             indicator.style.display = 'none';
         }
         if (newLabel) {
             newLabel.style.display = 'none';
         }
     }

     // Reset unread count
     if (unreadMessages[userId]) {
         unreadMessages[userId] = 0;
     }
 }

 // Handle user status updates
 function handleStatusUpdate(statusUpdate) {
     console.log("üîÑ Processing status update:", statusUpdate);

     if (statusUpdate.type === "USER_STATUS_UPDATE") {
         if (statusUpdate.status === "ONLINE") {
             const existingUser = document.querySelector(`[data-user-id="${statusUpdate.userId}"]`);

             if (!existingUser) {
                 addUserToList({
                     userId: statusUpdate.userId,
                     userName: statusUpdate.userName,
                     status: "online",
                     gender: statusUpdate.gender || "MALE",
                     country: statusUpdate.country || 'Unknown'
                 });
                 console.log("‚úÖ Added new user from status update:", statusUpdate.userName);
             } else {
                 updateUserStatus(statusUpdate.userId, "online");
             }
         } else if (statusUpdate.status === "OFFLINE") {
             updateUserStatus(statusUpdate.userId, "offline");
         }
     }
 }

 // Add user to sidebar list
 function addUserToList(user) {
     // Skip if it's current user
     if (user.userId == userId) {
         console.log("‚è© Skipping current user:", user.userName);
         return;
     }

     const existingUser = document.querySelector(`[data-user-id="${user.userId}"]`);
     if (existingUser) {
         console.log("‚è© User already exists, updating status:", user.userName);
         updateUserStatus(user.userId, "online");
         return;
     }

     const userList = document.getElementById("userList");

     if (!user.status) {
         user.status = 'online';
     }

     const userItem = createUserListItem(user);

     userList.insertBefore(userItem, userList.firstChild);
     console.log("‚úÖ Added NEW user to top of list:", user.userName);

     if (userList.children.length === 1 && !currentlySelectedUserId) {
         selectUser(user);
     }
 }

 // Update user status in sidebar
 function updateUserStatus(userId, status) {
     const userItem = document.querySelector(`[data-user-id="${userId}"]`);
     if (userItem) {
         const statusElement = userItem.querySelector('.user-status');
         const indicator = userItem.querySelector('.status-indicator');

         if (status === "online") {
             statusElement.innerHTML = '<span class="status-indicator"></span> Online';
             if (indicator) {
                 indicator.style.backgroundColor = '#4CAF50';
                 indicator.classList.remove('offline');
             }
         } else {
             statusElement.innerHTML = '<span class="status-indicator offline"></span> Offline';
             if (indicator) {
                 indicator.style.backgroundColor = '#ccc';
                 indicator.classList.add('offline');
             }
         }
         console.log("‚úÖ Updated user status:", userId, status);
     }

     if (inboxUsers.has(userId)) {
         const inboxItem = inboxUsers.get(userId);
         inboxItem.userData.status = status;
         if (activeTab === 'inbox') {
             refreshInboxList();
         }
     }
 }

 // Send message function - REMOVED BLOCK CHECK
function sendMessage() {
    const msgBox = document.getElementById("messageInput");
    const msg = msgBox.value.trim();
    const receiverId = currentlySelectedUserId;

    if (!msg || !receiverId) return;

    const messageRequest = {
        msg: msg,
        receiverId: parseInt(receiverId),
        senderId: userId
    };

    console.log("üì§ Sending message to:", receiverId);

    if (stompClient && isWebSocketConnected) {
        try {
            stompClient.send("/app/chat.send", {}, JSON.stringify(messageRequest));
            console.log("‚úÖ Message sent");

            // Add to inbox (for sent messages - but no red dot)
            addToInbox(parseInt(receiverId), messageRequest, false);

            // Move the receiver to top of the list
            moveUserToTop(parseInt(receiverId));

            // Clear input and reset height WITHOUT removing focus
            msgBox.value = "";
            msgBox.style.height = 'auto';

            // Immediately return focus to prevent keyboard from closing
            // No setTimeout needed - instant focus maintains keyboard
            msgBox.focus();

        } catch (error) {
            console.error("‚ùå Error sending message:", error);
        }
    } else {
        console.error("‚ùå WebSocket not connected");
        connectWebSocket();
    }
}
 // Display message in chat
 function displayMessage(messageData) {
     if (messageData.type === 'system') {
         return;
     }

     const messages = document.getElementById("messages");
     const senderId = parseInt(messageData.senderId);

     const shouldDisplay =
         senderId === userId ||
         (senderId === currentlySelectedUserId && parseInt(messageData.receiverId) === userId);

     if (shouldDisplay) {
         if (messages.querySelector('.no-chat')) {
             messages.innerHTML = '';
         }

         const newMsg = document.createElement("div");
         const isFromYou = senderId === userId;
         newMsg.className = isFromYou ? "message sent" : "message received";

         let timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

         newMsg.innerHTML = `
             <div class="message-bubble">${messageData.msg}</div>
             <div class="message-time">${timeString}</div>
         `;
         messages.appendChild(newMsg);
         messages.scrollTop = messages.scrollHeight;
     }
 }

 // Fetch active users from server
 function fetchActiveUsers() {
     fetch(`${userApiUrl}/find-by-status/online`, {
         method: "GET",
         credentials: "include"
     })
     .then(response => response.json())
     .then(users => {
         console.log('üë• Active users:', users);

         const usersWithStatus = users.map(user => ({
             ...user,
             status: 'online'
         }));

         populateUserList(usersWithStatus);
     })
     .catch(error => {
         console.error('Error fetching users:', error);
         populateUserListWithMockData();
     });
 }

 // Display system message as temporary alert
 function displaySystemMessage(messageData) {
     const notification = document.createElement("div");
     notification.className = "system-notification";
     notification.innerHTML = `
         <div class="notification-content">
             <i class="fas fa-info-circle"></i>
             <span>${messageData.msg}</span>
         </div>
     `;

     document.body.appendChild(notification);

     setTimeout(() => {
         notification.classList.add("show");
     }, 100);

     setTimeout(() => {
         notification.classList.remove("show");
         setTimeout(() => {
             if (notification.parentNode) {
                 notification.parentNode.removeChild(notification);
             }
         }, 300);
     }, 5000);

     console.log("‚úÖ System notification displayed");
 }

 // Populate user list initially
 function populateUserList(users) {
     const userList = document.getElementById("userList");
     userList.innerHTML = '';

     if (users.length === 0) {
         userList.innerHTML = `
             <div class="empty-state">
                 <i class="fas fa-users"></i>
                 <p>No active users found</p>
             </div>
         `;
         return;
     }

     users.forEach(user => {
         if (user.userId == userId) return;

         const userItem = createUserListItem(user);

         if (users.indexOf(user) === 0 && !currentlySelectedUserId) {
             selectUser(user);
         }

         userList.appendChild(userItem);
     });
 }

 // Set current chat user
 function setCurrentChatUser(user) {
     currentChatUser = user;
     document.getElementById("currentChatName").textContent = user.userName;
     document.getElementById("currentChatAvatar").textContent = user.userName.charAt(0).toUpperCase();
     document.getElementById("currentChatStatus").textContent = user.status === 'online' ? 'Online' : 'Offline';
     document.getElementById("currentChatGender").textContent = user.gender === 'FEMALE' ? 'Female' : 'Male';
     document.getElementById("currentChatCountry").textContent = user.country || 'Unknown';

     // Show chat actions and check block status
     document.getElementById("chatActions").style.display = 'flex';
     checkBlockStatus(user.userId);
 }

 // Load chat history for a user
 function loadChatHistory(targetUserId) {
     console.log('üí¨ Loading chat history for user:', targetUserId);

     const messagesContainer = document.getElementById("messages");
     messagesContainer.innerHTML = '<div class="no-chat">Loading messages...</div>';

     fetch(`${chatApiUrl}/get-chat-history/${userId}/${targetUserId}`)
     .then(response => {
         if (!response.ok) {
             throw new Error(`HTTP error! status: ${response.status}`);
         }
         return response.json();
     })
     .then(messages => {
         console.log('üìö Chat history loaded:', messages);
         displayChatHistory(messages, targetUserId);
         clearMessageIndicators(targetUserId);
     })
     .catch(error => {
         console.error('‚ùå Error loading chat history:', error);
         messagesContainer.innerHTML = '<div class="no-chat">No messages yet. Start the conversation!</div>';
     });
 }

 // Display chat history in the messages container
 function displayChatHistory(messages, targetUserId) {
     const messagesContainer = document.getElementById("messages");
     messagesContainer.innerHTML = '';

     if (messages.length === 0) {
         messagesContainer.innerHTML = '<div class="no-chat">No messages yet. Start the conversation!</div>';
         return;
     }

     messages.sort((a, b) => a.id - b.id);

     messages.forEach(message => {
         const messageElement = document.createElement("div");
         const isFromYou = parseInt(message.senderId) === userId;
         messageElement.className = isFromYou ? "message sent" : "message received";

         let timeString = message.sentTime;

         messageElement.innerHTML = `
             <div class="message-bubble">${message.msg}</div>
             <div class="message-time">${timeString}</div>
         `;
         messagesContainer.appendChild(messageElement);
     });

     messagesContainer.scrollTop = messagesContainer.scrollHeight;
     console.log(`‚úÖ Displayed ${messages.length} messages from history in correct order`);
 }

 // Check if current chat user is blocked
 function checkBlockStatus(targetUserId) {
     const url = `/user/api/user/isblocked/${userId}/${targetUserId}`;
     console.log('üîç Checking block status with URL:', url);

     fetch(url, {
         method: "GET",
         credentials: "include"
     })
     .then(response => {
         console.log('üìä Block status response - Status:', response.status, 'OK:', response.ok);
         if (!response.ok) {
             throw new Error(`HTTP ${response.status}: ${response.statusText}`);
         }
         return response.json();
     })
     .then(isBlocked => {
         console.log('‚úÖ Block status result:', isBlocked);
         isBlockedStatus = isBlocked;
         updateBlockButton(isBlocked);

         // Show blocked message if user is blocked
         if (isBlocked) {
             showBlockedMessage();
         }
     })
     .catch(error => {
         console.error('‚ùå Error checking block status:', error);
         isBlockedStatus = false;
         updateBlockButton(false);
     });
 }

 // Block or unblock user
 function toggleBlockUser() {
     if (!currentlySelectedUserId) {
         console.error('‚ùå No user selected to block/unblock');
         return;
     }

     const targetUserId = currentlySelectedUserId;

     console.log('üîç Debugging block operation:');
     console.log('  - Current userId (should be blockedBy):', userId);
     console.log('  - Target userId (should be blockedTo):', targetUserId);
     console.log('  - Current block status:', isBlockedStatus);

     if (isBlockedStatus) {
         // Unblock user
         const url = `/user/api/user/unblock/${userId}/${targetUserId}`;
         console.log('üîì Unblocking user with URL:', url);

         fetch(url, {
             method: "POST",
             credentials: "include"
         })
         .then(response => {
             console.log('üìä Unblock response - Status:', response.status, 'OK:', response.ok);

             if (response.ok) {
                 console.log('‚úÖ User unblocked successfully');
                 isBlockedStatus = false;
                 updateBlockButton(false);
                 removeBlockedMessage();
                 // Refresh the block status
                 checkBlockStatus(targetUserId);
             } else {
                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
             }
         })
         .catch(error => {
             console.error('‚ùå Error unblocking user:', error);
             displaySystemMessage({
                 msg: 'Failed to unblock user. Please try again.',
                 type: 'system'
             });
         });
     } else {
         // Block user
         const blockRequest = {
             blockedTo: targetUserId,
             blockedBy: userId
         };

         const url = `/user/api/user/block`;
         console.log('üö´ Blocking user with URL:', url, 'Request:', blockRequest);

         fetch(url, {
             method: "POST",
             headers: {
                 'Content-Type': 'application/json'
             },
             body: JSON.stringify(blockRequest),
             credentials: "include"
         })
         .then(response => {
             console.log('üìä Block response - Status:', response.status, 'OK:', response.ok);

             if (response.ok) {
                 console.log('‚úÖ User blocked successfully');
                 isBlockedStatus = true;
                 updateBlockButton(true);
                 showBlockedMessage();
                 // Refresh the block status
                 checkBlockStatus(targetUserId);
             } else {
                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
             }
         })
         .catch(error => {
             console.error('‚ùå Error blocking user:', error);
             displaySystemMessage({
                 msg: 'Failed to block user. Please try again.',
                 type: 'system'
             });
         });
     }
 }

 // Update block button appearance based on current status
 function updateBlockButton(isBlocked) {
     const blockBtn = document.getElementById('blockUserBtn');
     if (!blockBtn) {
         console.error('‚ùå Block button not found');
         return;
     }

     if (isBlocked) {
         blockBtn.classList.add('blocked');
         blockBtn.innerHTML = '<i class="fas fa-user-check"></i><span>Unblock</span>';
     } else {
         blockBtn.classList.remove('blocked');
         blockBtn.innerHTML = '<i class="fas fa-ban"></i><span>Block</span>';
     }
     console.log('‚úÖ Block button updated, isBlocked:', isBlocked);
 }

 // Show blocked message in chat
 function showBlockedMessage() {
     const messagesContainer = document.getElementById("messages");
     const blockedMessage = messagesContainer.querySelector('.blocked-message');

     if (!blockedMessage) {
         const messageElement = document.createElement("div");
         messageElement.className = "blocked-message";
         messageElement.textContent = "You have blocked this user. You won't receive messages from them.";
         messagesContainer.appendChild(messageElement);
     }
 }

 // Remove blocked message from chat
 function removeBlockedMessage() {
     const messagesContainer = document.getElementById("messages");
     const blockedMessage = messagesContainer.querySelector('.blocked-message');
     if (blockedMessage) {
         blockedMessage.remove();
     }
 }

 // Mock data fallback
 function populateUserListWithMockData() {
     const mockUsers = [
         { userId: 1, userName: "John Doe", gender: "MALE", country: "USA", status: "online" },
         { userId: 2, userName: "Jane Smith", gender: "FEMALE", country: "Canada", status: "online" }
     ];
     populateUserList(mockUsers);
 }

 // Event listeners
 // Event listeners
function setupEventListeners() {
    const sendButton = document.getElementById("sendButton");
    const messageInput = document.getElementById("messageInput");

    // Send button click with keyboard stability
    sendButton.addEventListener("click", function(e) {
        e.preventDefault(); // Prevent any default behavior
        sendMessage();
    });

    // Also handle touch events for mobile to prevent focus loss
    sendButton.addEventListener("touchend", function(e) {
        e.preventDefault(); // Prevent default touch behavior
        sendMessage();
    });

    // Enter key handling while keeping keyboard open
    messageInput.addEventListener("keypress", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    document.getElementById("logoutBtn").addEventListener("click", function() {
        if (stompClient) stompClient.disconnect();
        fetch(`${userApiUrl}/logout`, { method: "GET", credentials: "include" })
        .then(() => {
            window.location.href = "signin.html";
        });
    });

    document.getElementById("dashboardBtn").addEventListener("click", function() {
        window.location.href = "dashboard.html";
    });

    // Keep block button event listener
    document.getElementById("blockUserBtn").addEventListener("click", toggleBlockUser);
}
// Prevent keyboard from closing on send
function setupKeyboardPersistence() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Prevent blur on send button click
    sendButton.addEventListener('touchstart', function(e) {
        e.preventDefault();
        sendMessage();
        // Keep focus on input to maintain keyboard
        setTimeout(() => {
            messageInput.focus();
        }, 10);
    });

    // Handle Enter key while keeping keyboard open
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
            // Keep focus to maintain keyboard
            setTimeout(() => {
                messageInput.focus();
            }, 10);
        }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
}
// Initialize app
// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Strangerblink...');

    initializeEmojiPicker();
    setupMobileControls();
    setupBackButtonHandler();
    setupKeyboardPersistence(); // ‚Üê ADD THIS LINE

    checkUserSession()
        .then((userData) => {
            console.log('üéØ User session validated:', userData);
            console.log('üéØ User ID:', userId);

            setupTabSwitching();
            setupSearchAndFilter();
            setupEventListeners();

            return connectWebSocket();
        })
        .then(() => {
            console.log('‚úÖ WebSocket connected and subscriptions active');
            fetchActiveUsers();
            monitorConnection();
            console.log('‚úÖ Strangerblink fully initialized');
        })
        .catch(error => {
            console.error('‚ùå Failed to initialize Strangerblink:', error);
            alert('Failed to connect to chat service. Please refresh the page.');
        });
});
</script>
</body>
</html>